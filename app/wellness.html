<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Wellness Check-in üå∏</title>
    <style>
        :root {
            --bg: #faf8f5;
            --card: #ffffff;
            --text: #1d1d1f;
            --text-secondary: #6e6e73;
            --pink: #ff6b9d;
            --pink-light: #fff0f5;
            --green: #34c759;
            --shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            padding: 20px;
            padding-bottom: 100px;
        }

        .container { max-width: 500px; margin: 0 auto; }

        header { text-align: center; padding: 30px 0; }
        .header-icon { font-size: 48px; }
        
        h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 8px 0;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle { color: var(--text-secondary); font-size: 15px; }

        .card {
            background: var(--card);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .card-title {
            font-weight: 600;
            font-size: 17px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rating-group { margin-bottom: 20px; }
        .rating-scale { display: flex; gap: 8px; }

        .rating-btn {
            flex: 1;
            padding: 12px 8px;
            border: 2px solid #e8e8ed;
            background: white;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rating-btn:hover { border-color: var(--pink); }
        .rating-btn.selected {
            background: var(--pink);
            border-color: var(--pink);
            color: white;
        }

        .symptoms-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .symptom-btn {
            padding: 12px;
            border: 2px solid #e8e8ed;
            background: white;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .symptom-btn:hover { border-color: var(--pink); }
        .symptom-btn.selected {
            background: var(--pink-light);
            border-color: var(--pink);
        }

        textarea {
            width: 100%;
            min-height: 100px;
            border: 2px solid #e8e8ed;
            border-radius: 14px;
            padding: 14px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
        }

        textarea:focus { outline: none; border-color: var(--pink); }

        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
            box-shadow: 0 4px 20px rgba(255, 107, 157, 0.4);
        }

        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .response-card {
            background: linear-gradient(135deg, #fff0f5 0%, #faf8f5 100%);
            border: 2px solid var(--pink);
            border-radius: 20px;
            padding: 24px;
            margin-top: 20px;
            display: none;
        }

        .response-card.visible { display: block; }

        .response-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .response-title { font-weight: 600; color: var(--pink); }

        .response-content {
            font-size: 15px;
            line-height: 1.7;
            color: var(--text);
        }

        .response-content p { margin-bottom: 12px; }
        .response-content p:last-child { margin-bottom: 0; }

        .loading { text-align: center; padding: 40px; display: none; }
        .loading.visible { display: block; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e8e8ed;
            border-top-color: var(--pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .nav-tabs { display: flex; gap: 8px; margin-bottom: 20px; }

        .nav-tab {
            flex: 1;
            padding: 12px;
            border: 2px solid #e8e8ed;
            background: white;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
        }

        .nav-tab.active {
            background: var(--pink);
            border-color: var(--pink);
            color: white;
        }

        .history-item {
            padding: 16px 0;
            border-bottom: 1px solid #e8e8ed;
        }

        .history-item:last-child { border-bottom: none; }
        .history-date { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
        .history-mood { font-weight: 600; margin-bottom: 8px; }
        .history-notes { font-size: 14px; color: var(--text-secondary); }

        .back-link {
            display: inline-block;
            color: var(--pink);
            text-decoration: none;
            font-size: 15px;
            margin-bottom: 20px;
        }

        .completed-card {
            text-align: center;
            padding: 40px 20px;
        }

        .completed-icon { font-size: 64px; margin-bottom: 16px; }
        .completed-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        .completed-subtitle { color: var(--text-secondary); margin-bottom: 24px; }
        
        .next-checkin-btn {
            background: var(--pink-light);
            border: 2px solid var(--pink);
            color: var(--pink);
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
        }

        .checkin-type-badge {
            display: inline-block;
            background: var(--pink);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="kc.html" class="back-link">‚Üê Back to Baby G</a>
        
        <header>
            <div class="header-icon">üå∏</div>
            <h1>Wellness Check-in</h1>
            <p class="subtitle" id="greeting">How are you feeling?</p>
        </header>

        <div class="nav-tabs">
            <div class="nav-tab active" data-view="checkin">Check In</div>
            <div class="nav-tab" data-view="history">History</div>
        </div>

        <!-- Completed State -->
        <div id="completed-view" class="card completed-card" style="display: none;">
            <div class="completed-icon">‚ú®</div>
            <div class="completed-title" id="completed-title">Morning check-in complete!</div>
            <div class="completed-subtitle" id="completed-subtitle">Come back this evening for your next check-in</div>
            <button class="next-checkin-btn" id="force-checkin-btn" style="display: none;">Do Evening Check-in Now</button>
        </div>

        <!-- Check-in Form -->
        <div id="checkin-view">
            <div class="checkin-type-badge" id="checkin-type-badge">üåÖ Morning Check-in</div>
            
            <form id="checkin-form">
                <div class="card">
                    <div class="card-title">üò¥ Sleep Quality</div>
                    <div class="rating-group">
                        <div class="rating-scale" data-field="sleep">
                            <button type="button" class="rating-btn" data-value="1">1<br><span style="font-size:10px">Rough</span></button>
                            <button type="button" class="rating-btn" data-value="2">2</button>
                            <button type="button" class="rating-btn" data-value="3">3</button>
                            <button type="button" class="rating-btn" data-value="4">4</button>
                            <button type="button" class="rating-btn" data-value="5">5<br><span style="font-size:10px">Great</span></button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">‚ö° Energy Level</div>
                    <div class="rating-group">
                        <div class="rating-scale" data-field="energy">
                            <button type="button" class="rating-btn" data-value="1">1<br><span style="font-size:10px">Low</span></button>
                            <button type="button" class="rating-btn" data-value="2">2</button>
                            <button type="button" class="rating-btn" data-value="3">3</button>
                            <button type="button" class="rating-btn" data-value="4">4</button>
                            <button type="button" class="rating-btn" data-value="5">5<br><span style="font-size:10px">High</span></button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üíï Overall Mood</div>
                    <div class="rating-group">
                        <div class="rating-scale" data-field="mood">
                            <button type="button" class="rating-btn" data-value="1">üò¢</button>
                            <button type="button" class="rating-btn" data-value="2">üòï</button>
                            <button type="button" class="rating-btn" data-value="3">üòê</button>
                            <button type="button" class="rating-btn" data-value="4">üôÇ</button>
                            <button type="button" class="rating-btn" data-value="5">üòä</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ü©∫ Any Symptoms?</div>
                    <div class="symptoms-grid" id="symptoms">
                        <button type="button" class="symptom-btn" data-symptom="nausea">ü§¢ Nausea</button>
                        <button type="button" class="symptom-btn" data-symptom="fatigue">üò¥ Fatigue</button>
                        <button type="button" class="symptom-btn" data-symptom="headache">ü§ï Headache</button>
                        <button type="button" class="symptom-btn" data-symptom="backpain">üíÜ Back pain</button>
                        <button type="button" class="symptom-btn" data-symptom="cramps">üò£ Cramps</button>
                        <button type="button" class="symptom-btn" data-symptom="bloating">ü´Ñ Bloating</button>
                        <button type="button" class="symptom-btn" data-symptom="heartburn">üî• Heartburn</button>
                        <button type="button" class="symptom-btn" data-symptom="anxiety">üò∞ Anxiety</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üí≠ Anything else on your mind?</div>
                    <textarea id="notes" placeholder="Share whatever's on your heart... cravings, worries, wins, questions, or just how your day went üíï"></textarea>
                </div>

                <button type="submit" class="submit-btn" id="submit-btn">
                    Submit Check-in ‚ú®
                </button>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Getting your personalized response...</p>
            </div>

            <div class="response-card" id="response-card">
                <div class="response-header">
                    <span style="font-size: 24px;">üíï</span>
                    <span class="response-title">For You</span>
                </div>
                <div class="response-content" id="response-content"></div>
                <button class="submit-btn" style="margin-top: 20px; background: var(--green);" onclick="window.location.href='kc.html'">Done ‚úì</button>
            </div>
        </div>

        <!-- History View -->
        <div id="history-view" style="display: none;">
            <div class="card">
                <div class="card-title">üìÖ Recent Check-ins</div>
                <div id="history-list">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">Loading history...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://rtduqguwhkczexnoawej.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZHVxZ3V3aGtjemV4bm9hd2VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2Njg1ODAsImV4cCI6MjA2NzI0NDU4MH0.HmXbJtvmyPJzKRDCprw0dDJjVfvnIDNjMqL3RQlvJT4';

        let formData = { sleep: null, energy: null, mood: null, symptoms: [], notes: '' };
        let currentCheckinType = 'morning';

        // Check-in state management
        function getCheckinState() {
            const state = localStorage.getItem('wellness_checkin_state');
            return state ? JSON.parse(state) : {};
        }

        function saveCheckinState(type) {
            const today = new Date().toISOString().split('T')[0];
            const state = getCheckinState();
            state[today] = state[today] || {};
            state[today][type] = new Date().toISOString();
            localStorage.setItem('wellness_checkin_state', JSON.stringify(state));
        }

        function getTodayCheckins() {
            const today = new Date().toISOString().split('T')[0];
            const state = getCheckinState();
            return state[today] || {};
        }

        function determineCheckinType() {
            const hour = new Date().getHours();
            const todayCheckins = getTodayCheckins();
            
            // Before noon = morning time
            if (hour < 12) {
                if (todayCheckins.morning) {
                    return { type: null, completed: 'morning' };
                }
                return { type: 'morning', completed: null };
            }
            
            // After noon = evening time
            if (todayCheckins.evening) {
                return { type: null, completed: 'both' };
            }
            if (todayCheckins.morning) {
                return { type: 'evening', completed: 'morning' };
            }
            // Afternoon but no morning - still offer evening
            return { type: 'evening', completed: null };
        }

        function updateUI() {
            const { type, completed } = determineCheckinType();
            const hour = new Date().getHours();
            
            const checkinView = document.getElementById('checkin-view');
            const completedView = document.getElementById('completed-view');
            const greeting = document.getElementById('greeting');
            const badge = document.getElementById('checkin-type-badge');
            
            if (!type) {
                // Already completed the relevant check-in
                checkinView.style.display = 'none';
                completedView.style.display = 'block';
                
                const title = document.getElementById('completed-title');
                const subtitle = document.getElementById('completed-subtitle');
                const forceBtn = document.getElementById('force-checkin-btn');
                
                if (completed === 'both') {
                    title.textContent = "All done for today! üåü";
                    subtitle.textContent = "You've completed both check-ins. See you tomorrow!";
                    forceBtn.style.display = 'none';
                } else if (completed === 'morning' && hour < 17) {
                    title.textContent = "Morning check-in complete! ‚ú®";
                    subtitle.textContent = "Come back this evening for your next check-in";
                    forceBtn.textContent = "Do Evening Check-in Now";
                    forceBtn.style.display = 'inline-block';
                    forceBtn.onclick = () => {
                        currentCheckinType = 'evening';
                        completedView.style.display = 'none';
                        checkinView.style.display = 'block';
                        badge.textContent = 'üåô Evening Check-in';
                        greeting.textContent = 'How was your day? üåô';
                    };
                } else {
                    title.textContent = "Evening check-in complete! üåô";
                    subtitle.textContent = "Rest well! See you tomorrow morning.";
                    forceBtn.style.display = 'none';
                }
            } else {
                currentCheckinType = type;
                checkinView.style.display = 'block';
                completedView.style.display = 'none';
                
                if (type === 'morning') {
                    badge.textContent = 'üåÖ Morning Check-in';
                    greeting.textContent = 'Good morning! How did you sleep? üåÖ';
                } else {
                    badge.textContent = 'üåô Evening Check-in';
                    greeting.textContent = 'How was your day? üåô';
                }
            }
        }

        // Rating buttons
        document.querySelectorAll('.rating-scale').forEach(scale => {
            const field = scale.dataset.field;
            scale.querySelectorAll('.rating-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    scale.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    formData[field] = parseInt(btn.dataset.value);
                });
            });
        });

        // Symptom buttons
        document.querySelectorAll('.symptom-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('selected');
                const symptom = btn.dataset.symptom;
                if (btn.classList.contains('selected')) {
                    formData.symptoms.push(symptom);
                } else {
                    formData.symptoms = formData.symptoms.filter(s => s !== symptom);
                }
            });
        });

        document.getElementById('notes').addEventListener('input', (e) => {
            formData.notes = e.target.value;
        });

        // Tab navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const view = tab.dataset.view;
                document.getElementById('checkin-view').style.display = view === 'checkin' ? 'block' : 'none';
                document.getElementById('history-view').style.display = view === 'history' ? 'block' : 'none';
                document.getElementById('completed-view').style.display = 'none';
                
                if (view === 'checkin') {
                    updateUI();
                } else if (view === 'history') {
                    loadHistory();
                }
            });
        });

        // Form submit
        document.getElementById('checkin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = document.getElementById('checkin-form');
            const loading = document.getElementById('loading');
            const responseCard = document.getElementById('response-card');
            const submitBtn = document.getElementById('submit-btn');
            
            submitBtn.disabled = true;
            form.style.display = 'none';
            loading.classList.add('visible');
            responseCard.classList.remove('visible');

            try {
                const aiResponse = await getAIResponse(formData);
                await saveCheckin(formData, aiResponse);
                
                // Mark as completed
                saveCheckinState(currentCheckinType);
                
                document.getElementById('response-content').innerHTML = formatResponse(aiResponse);
                loading.classList.remove('visible');
                responseCard.classList.add('visible');
                
            } catch (error) {
                console.error('Error:', error);
                loading.classList.remove('visible');
                form.style.display = 'block';
                submitBtn.disabled = false;
                alert('Something went wrong. Please try again!');
            }
        });

        async function getAIResponse(data) {
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/wellness-ai`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({ ...data, checkinType: currentCheckinType })
                });
                
                if (!response.ok) throw new Error('API error');
                const result = await response.json();
                return result.response;
            } catch (e) {
                return generateFallbackResponse(data);
            }
        }

        function generateFallbackResponse(data) {
            let response = '';
            if (data.mood <= 2) {
                response += "I'm sorry you're not feeling your best today. Remember, it's okay to have hard days. üíï\n\n";
            } else if (data.mood >= 4) {
                response += "So glad you're feeling good today! That's wonderful. ‚ú®\n\n";
            }
            if (data.sleep <= 2) {
                response += "Rest is so important right now. Try to sneak in a nap if you can. üò¥\n\n";
            }
            if (data.symptoms.includes('nausea')) {
                response += "For the nausea, try small frequent meals and ginger tea. üç™\n\n";
            }
            return response || "Thank you for checking in! Take care of yourself today. üíï";
        }

        async function saveCheckin(data, aiResponse) {
            await fetch(`${SUPABASE_URL}/rest/v1/wellness_checkins`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({
                    checkin_type: currentCheckinType,
                    sleep_quality: data.sleep,
                    energy_level: data.energy,
                    mood: data.mood,
                    symptoms: data.symptoms,
                    notes: data.notes,
                    ai_response: aiResponse
                })
            });
        }

        async function loadHistory() {
            const historyList = document.getElementById('history-list');
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/wellness_checkins?order=created_at.desc&limit=10`, {
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                });
                const checkins = await response.json();
                
                if (!checkins.length) {
                    historyList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No check-ins yet. Start your first one! üíï</p>';
                    return;
                }
                
                const moodEmojis = ['', 'üò¢', 'üòï', 'üòê', 'üôÇ', 'üòä'];
                historyList.innerHTML = checkins.map(c => {
                    const date = new Date(c.created_at);
                    return `
                        <div class="history-item">
                            <div class="history-date">${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} ‚Ä¢ ${c.checkin_type}</div>
                            <div class="history-mood">${moodEmojis[c.mood] || ''} Mood: ${c.mood}/5 ‚Ä¢ Sleep: ${c.sleep_quality}/5 ‚Ä¢ Energy: ${c.energy_level}/5</div>
                            ${c.notes ? `<div class="history-notes">"${c.notes.substring(0, 100)}${c.notes.length > 100 ? '...' : ''}"</div>` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                historyList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Could not load history</p>';
            }
        }

        function formatResponse(text) {
            return text.split('\n\n').map(p => `<p>${p}</p>`).join('');
        }

        // Init
        updateUI();
    </script>
</body>
</html>
