<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center - Jonathan Greenberg</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.5); } 50% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.8); } }
        .card-enter { animation: slideIn 0.3s ease-out; }
        .pulse { animation: pulse 2s infinite; }
        .glow-urgent { animation: glow 2s infinite; }
        .priority-urgent { border-left: 4px solid #ef4444; background: linear-gradient(90deg, rgba(239,68,68,0.1) 0%, transparent 100%); }
        .priority-high { border-left: 4px solid #f59e0b; }
        .priority-medium { border-left: 4px solid #3b82f6; }
        .priority-low { border-left: 4px solid #6b7280; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); min-height: 100vh; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .stat-card { backdrop-filter: blur(10px); }
    </style>
</head>
<body class="text-gray-100">
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6">
        
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                    <span class="text-3xl">‚ö°</span> Command Center
                </h1>
                <p class="text-gray-400 text-sm mt-1">Full visibility across SOS, Reforge, and Harmony</p>
            </div>
            <div class="flex gap-2 items-center flex-wrap">
                <span id="lastUpdate" class="text-xs text-gray-500 mr-2"></span>
                <button onclick="setView('today')" class="view-btn px-3 py-1.5 bg-red-600/30 hover:bg-red-600/50 rounded-lg text-sm border border-red-500/30">
                    üî• Today
                </button>
                <button onclick="setView('all')" class="view-btn px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">
                    All Tasks
                </button>
                <button onclick="window.location='decision-queue.html'" class="px-3 py-1.5 bg-purple-600/30 hover:bg-purple-600/50 rounded-lg text-sm border border-purple-500/30">
                    üìä Decision Queue
                </button>
            </div>
        </div>

        <!-- Top Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-6">
            <div class="stat-card bg-red-500/20 border border-red-500/30 rounded-lg p-3 text-center">
                <div id="urgentCount" class="text-2xl font-bold text-red-400">-</div>
                <div class="text-xs text-gray-400">üî• Urgent</div>
            </div>
            <div class="stat-card bg-yellow-500/20 border border-yellow-500/30 rounded-lg p-3 text-center">
                <div id="highCount" class="text-2xl font-bold text-yellow-400">-</div>
                <div class="text-xs text-gray-400">‚ö†Ô∏è High</div>
            </div>
            <div class="stat-card bg-green-500/20 border border-green-500/30 rounded-lg p-3 text-center">
                <div id="doneCount" class="text-2xl font-bold text-green-400">-</div>
                <div class="text-xs text-gray-400">‚úÖ Done</div>
            </div>
            <div class="stat-card bg-blue-500/20 border border-blue-500/30 rounded-lg p-3 text-center">
                <div id="pipelineValue" class="text-2xl font-bold text-blue-400">-</div>
                <div class="text-xs text-gray-400">üí∞ Pipeline</div>
            </div>
            <div class="stat-card bg-purple-500/20 border border-purple-500/30 rounded-lg p-3 text-center">
                <div id="grantsCount" class="text-2xl font-bold text-purple-400">-</div>
                <div class="text-xs text-gray-400">üìã Grants</div>
            </div>
            <div class="stat-card bg-cyan-500/20 border border-cyan-500/30 rounded-lg p-3 text-center">
                <div id="quotaPct" class="text-2xl font-bold text-cyan-400">-</div>
                <div class="text-xs text-gray-400">üìà Q1 Quota</div>
            </div>
        </div>

        <!-- Project Tabs -->
        <div class="flex gap-2 mb-4 overflow-x-auto scrollbar-hide pb-2">
            <button onclick="filterProject('')" class="project-btn whitespace-nowrap px-4 py-2 bg-gradient-to-r from-gray-700 to-gray-800 rounded-lg text-sm font-medium border border-gray-600" data-project="">
                üåê All Projects
            </button>
            <button onclick="filterProject('sos')" class="project-btn whitespace-nowrap px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm border border-gray-700" data-project="sos">
                üÜò SOS
            </button>
            <button onclick="filterProject('reforge')" class="project-btn whitespace-nowrap px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm border border-gray-700" data-project="reforge">
                üöÄ Reforge
            </button>
            <button onclick="filterProject('harmony')" class="project-btn whitespace-nowrap px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm border border-gray-700" data-project="harmony">
                üéØ Harmony
            </button>
            <button onclick="filterProject('context_graph')" class="project-btn whitespace-nowrap px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm border border-gray-700" data-project="context_graph">
                üß† Context Graph
            </button>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column: Urgent + High Priority -->
            <div class="lg:col-span-2 space-y-4">
                
                <!-- Urgent Tasks -->
                <div id="urgentSection" class="bg-gray-800/50 border border-red-500/30 rounded-xl p-4">
                    <h2 class="text-lg font-bold flex items-center gap-2 mb-3 text-red-400">
                        <span class="pulse">üî•</span> Urgent - Do Today
                    </h2>
                    <div id="urgentTasks" class="space-y-2"></div>
                </div>

                <!-- High Priority -->
                <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-4">
                    <h2 class="text-lg font-bold flex items-center gap-2 mb-3 text-yellow-400">
                        ‚ö†Ô∏è High Priority
                    </h2>
                    <div id="highTasks" class="space-y-2"></div>
                </div>

                <!-- All Other Tasks (collapsible by category) -->
                <div id="categorySections"></div>
            </div>

            <!-- Right Column: Metrics & Quick Actions -->
            <div class="space-y-4">
                
                <!-- Reforge Quota Tracker -->
                <div class="bg-gradient-to-br from-blue-900/30 to-cyan-900/30 border border-blue-500/30 rounded-xl p-4">
                    <h3 class="font-bold flex items-center gap-2 mb-3">
                        üöÄ Reforge Q1 Progress
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Meetings</span>
                                <span id="meetingsProgress">-/-</span>
                            </div>
                            <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div id="meetingsBar" class="h-full bg-blue-500 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>ARR</span>
                                <span id="arrProgress">-/-</span>
                            </div>
                            <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div id="arrBar" class="h-full bg-green-500 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SOS Progress -->
                <div class="bg-gradient-to-br from-red-900/30 to-orange-900/30 border border-red-500/30 rounded-xl p-4">
                    <h3 class="font-bold flex items-center gap-2 mb-3">
                        üÜò SOS MVP Progress
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">MVP Completion</span>
                            <span id="mvpCompletion" class="font-bold">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Partners Active</span>
                            <span id="partnersActive">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Grants in Pipeline</span>
                            <span id="grantsPipeline">-</span>
                        </div>
                        <div class="flex justify-between text-yellow-400">
                            <span>June Milestone</span>
                            <span>$275K</span>
                        </div>
                    </div>
                </div>

                <!-- Harmony Status -->
                <div class="bg-gradient-to-br from-purple-900/30 to-pink-900/30 border border-purple-500/30 rounded-xl p-4">
                    <h3 class="font-bold flex items-center gap-2 mb-3">
                        üéØ Harmony Status
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Active Retainers</span>
                            <span id="harmonyRetainers">-</span>
                        </div>
                        <div class="flex justify-between text-red-400">
                            <span>At Risk</span>
                            <span id="harmonyAtRisk">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Outstanding</span>
                            <span id="harmonyOutstanding">-</span>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Deadlines -->
                <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-4">
                    <h3 class="font-bold flex items-center gap-2 mb-3">
                        üìÖ Upcoming Deadlines
                    </h3>
                    <div id="deadlines" class="space-y-2 text-sm max-h-48 overflow-y-auto"></div>
                </div>

                <!-- Quick Links -->
                <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-4">
                    <h3 class="font-bold flex items-center gap-2 mb-3">
                        ‚ö° Quick Actions
                    </h3>
                    <div class="grid grid-cols-2 gap-2">
                        <a href="https://sos-help-the-helper.github.io/reforge-swipe/" target="_blank" 
                           class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm text-center transition">
                            üéØ Grunt Swipe
                        </a>
                        <a href="decision-queue.html" 
                           class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm text-center transition">
                            üìä Decisions
                        </a>
                        <button onclick="exportTasks()" 
                           class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm text-center transition">
                            üì• Export
                        </button>
                        <button onclick="refreshData()" 
                           class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm text-center transition">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tasksData = null;
        let currentProject = '';
        let currentView = 'today';

        const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
        const statusColors = {
            urgent: 'text-red-400',
            ready: 'text-green-400',
            'in_progress': 'text-blue-400',
            pending: 'text-yellow-400',
            blocked: 'text-orange-400',
            done: 'text-gray-500',
            future: 'text-gray-600',
            tracking: 'text-cyan-400',
            active: 'text-green-400'
        };

        async function loadTasks() {
            try {
                const r = await fetch('/data/tasks.json');
                if (!r.ok) throw new Error('Failed to load tasks');
                tasksData = await r.json();
                
                updateStats();
                renderTasks();
                renderDeadlines();
                
                document.getElementById('lastUpdate').textContent = 
                    `Updated: ${new Date(tasksData.updated_at).toLocaleString()}`;
            } catch(e) {
                console.error('Load error:', e);
                document.getElementById('urgentTasks').innerHTML = 
                    '<div class="text-red-400">Failed to load tasks. Check server.</div>';
            }
        }

        function updateStats() {
            const allTasks = getAllTasks();
            const urgent = allTasks.filter(t => t.priority === 'urgent' && t.status !== 'done').length;
            const high = allTasks.filter(t => t.priority === 'high' && t.status !== 'done').length;
            const done = allTasks.filter(t => t.status === 'done').length;
            
            document.getElementById('urgentCount').textContent = urgent;
            document.getElementById('highCount').textContent = high;
            document.getElementById('doneCount').textContent = done;
            
            // Reforge pipeline
            const pipeline = tasksData.projects.reforge?.pipeline;
            if (pipeline) {
                document.getElementById('pipelineValue').textContent = `$${(pipeline.total_active/1000).toFixed(0)}K`;
            }
            
            // Grants count
            const grants = tasksData.projects.sos?.categories?.grant_pipeline?.tasks || [];
            const activeGrants = grants.filter(g => g.status !== 'future' && g.status !== 'done').length;
            document.getElementById('grantsCount').textContent = activeGrants;
            
            // Quota
            const quota = tasksData.projects.reforge?.quota;
            if (quota) {
                document.getElementById('quotaPct').textContent = `${quota.arr_pct}%`;
                document.getElementById('meetingsProgress').textContent = `${quota.current_meetings}/${quota.q1_target_meetings}`;
                document.getElementById('arrProgress').textContent = `$${(quota.current_arr/1000).toFixed(0)}K/$${(quota.q1_target_arr/1000).toFixed(0)}K`;
                document.getElementById('meetingsBar').style.width = `${quota.meetings_pct}%`;
                document.getElementById('arrBar').style.width = `${quota.arr_pct}%`;
            }
            
            // SOS metrics
            const sosMetrics = tasksData.projects.sos?.metrics;
            if (sosMetrics) {
                document.getElementById('mvpCompletion').textContent = `${sosMetrics.mvp_completion}%`;
                document.getElementById('partnersActive').textContent = `${sosMetrics.partners_active}/${sosMetrics.partners_active + sosMetrics.partners_pending}`;
                document.getElementById('grantsPipeline').textContent = sosMetrics.grants_pipeline;
            }
            
            // Harmony
            const harmonyRev = tasksData.projects.harmony?.revenue;
            if (harmonyRev) {
                document.getElementById('harmonyRetainers').textContent = `$${(harmonyRev.active_retainers/1000).toFixed(0)}K`;
                document.getElementById('harmonyAtRisk').textContent = `$${(harmonyRev.at_risk/1000).toFixed(0)}K`;
                document.getElementById('harmonyOutstanding').textContent = `$${(harmonyRev.outstanding_invoices/1000).toFixed(1)}K`;
            }
        }

        function getAllTasks() {
            const tasks = [];
            for (const [projKey, proj] of Object.entries(tasksData.projects)) {
                if (!proj.categories) continue;
                for (const [catKey, cat] of Object.entries(proj.categories)) {
                    for (const task of (cat.tasks || [])) {
                        tasks.push({
                            ...task,
                            projectKey: projKey,
                            projectName: proj.name,
                            projectEmoji: proj.emoji,
                            categoryKey: catKey,
                            categoryName: cat.name
                        });
                    }
                }
            }
            return tasks;
        }

        function filterTasks(tasks) {
            let filtered = tasks;
            
            // Project filter
            if (currentProject) {
                filtered = filtered.filter(t => t.projectKey === currentProject);
            }
            
            // View filter
            if (currentView === 'today') {
                filtered = filtered.filter(t => 
                    (t.priority === 'urgent' || t.priority === 'high') && 
                    t.status !== 'done' && t.status !== 'future'
                );
            }
            
            return filtered;
        }

        function renderTasks() {
            const allTasks = getAllTasks();
            const filtered = filterTasks(allTasks);
            
            // Sort by priority
            filtered.sort((a, b) => {
                const pa = priorityOrder[a.priority] ?? 99;
                const pb = priorityOrder[b.priority] ?? 99;
                return pa - pb;
            });
            
            // Urgent tasks
            const urgent = filtered.filter(t => t.priority === 'urgent' && t.status !== 'done');
            document.getElementById('urgentTasks').innerHTML = urgent.length > 0 
                ? urgent.map(t => renderTaskCard(t, true)).join('')
                : '<div class="text-gray-500 text-sm">No urgent tasks! üéâ</div>';
            
            // Show/hide urgent section
            document.getElementById('urgentSection').style.display = urgent.length > 0 ? 'block' : 'none';
            
            // High priority tasks
            const high = filtered.filter(t => t.priority === 'high' && t.status !== 'done');
            document.getElementById('highTasks').innerHTML = high.length > 0
                ? high.map(t => renderTaskCard(t)).join('')
                : '<div class="text-gray-500 text-sm">No high priority tasks pending</div>';
            
            // Category sections (medium/low only, grouped)
            if (currentView === 'all') {
                const others = filtered.filter(t => 
                    t.priority !== 'urgent' && t.priority !== 'high' && t.status !== 'done'
                );
                renderCategorySections(others);
            } else {
                document.getElementById('categorySections').innerHTML = '';
            }
        }

        function renderTaskCard(task, isUrgent = false) {
            const statusClass = statusColors[task.status] || 'text-gray-400';
            const priorityClass = `priority-${task.priority || 'medium'}`;
            const urgentClass = isUrgent ? 'glow-urgent' : '';
            
            const valueDisplay = task.value ? `<span class="text-green-400 font-bold">$${task.value.toLocaleString()}</span>` : '';
            const dueDisplay = task.due ? `<span class="text-yellow-400 text-xs">üìÖ ${task.due}</span>` : '';
            const contactDisplay = task.contact ? `<span class="text-gray-500 text-xs">üë§ ${task.contact}</span>` : '';
            
            return `
                <div class="card-enter bg-gray-900/50 rounded-lg p-3 ${priorityClass} ${urgentClass} hover:bg-gray-800/50 transition cursor-pointer"
                     onclick="toggleTaskDetails('${task.id}')">
                    <div class="flex justify-between items-start gap-2">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-xs">${task.projectEmoji || 'üìã'}</span>
                                <span class="font-medium text-sm truncate">${task.title}</span>
                            </div>
                            <div class="flex items-center gap-2 mt-1 flex-wrap">
                                <span class="px-1.5 py-0.5 rounded text-xs ${statusClass} bg-gray-800">${task.status}</span>
                                ${dueDisplay}
                                ${contactDisplay}
                            </div>
                        </div>
                        ${valueDisplay}
                    </div>
                    <div id="details-${task.id}" class="hidden mt-2 pt-2 border-t border-gray-700 text-sm text-gray-400">
                        ${task.notes || 'No additional details'}
                        ${task.file ? `<div class="mt-1 text-xs text-blue-400">üìÅ ${task.file}</div>` : ''}
                        ${task.url ? `<a href="${task.url}" target="_blank" class="mt-1 text-xs text-blue-400 block">üîó Open link</a>` : ''}
                    </div>
                </div>
            `;
        }

        function renderCategorySections(tasks) {
            // Group by project then category
            const grouped = {};
            for (const task of tasks) {
                const key = `${task.projectKey}-${task.categoryKey}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        projectName: task.projectName,
                        projectEmoji: task.projectEmoji,
                        categoryName: task.categoryName,
                        tasks: []
                    };
                }
                grouped[key].tasks.push(task);
            }
            
            const html = Object.entries(grouped).map(([key, group]) => `
                <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-4 mt-4">
                    <h3 class="font-bold flex items-center gap-2 mb-3 text-gray-300">
                        ${group.projectEmoji} ${group.projectName} / ${group.categoryName}
                        <span class="text-xs text-gray-500">(${group.tasks.length})</span>
                    </h3>
                    <div class="space-y-2">
                        ${group.tasks.map(t => renderTaskCard(t)).join('')}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('categorySections').innerHTML = html;
        }

        function renderDeadlines() {
            const allTasks = getAllTasks();
            const withDue = allTasks
                .filter(t => t.due && t.status !== 'done')
                .sort((a, b) => new Date(a.due) - new Date(b.due))
                .slice(0, 8);
            
            const html = withDue.map(t => {
                const dueDate = new Date(t.due);
                const today = new Date();
                const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                const urgencyClass = diffDays <= 1 ? 'text-red-400' : diffDays <= 7 ? 'text-yellow-400' : 'text-gray-400';
                
                return `
                    <div class="flex justify-between items-center py-1 border-b border-gray-700/50">
                        <span class="truncate text-xs">${t.projectEmoji} ${t.title.substring(0, 35)}...</span>
                        <span class="text-xs ${urgencyClass} whitespace-nowrap ml-2">${t.due}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('deadlines').innerHTML = html || '<div class="text-gray-500 text-sm">No upcoming deadlines</div>';
        }

        function toggleTaskDetails(taskId) {
            const details = document.getElementById(`details-${taskId}`);
            if (details) {
                details.classList.toggle('hidden');
            }
        }

        function filterProject(projectKey) {
            currentProject = projectKey;
            
            // Update button states
            document.querySelectorAll('.project-btn').forEach(btn => {
                const isActive = btn.dataset.project === projectKey;
                btn.className = btn.className.replace(/bg-gradient-to-r from-gray-700 to-gray-800|bg-gray-800/g, '');
                btn.className += isActive ? ' bg-gradient-to-r from-gray-700 to-gray-800' : ' bg-gray-800';
            });
            
            renderTasks();
        }

        function setView(view) {
            currentView = view;
            
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('bg-red-600/50', 'border-red-400');
            });
            
            renderTasks();
        }

        function exportTasks() {
            const blob = new Blob([JSON.stringify(tasksData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `command-center-tasks-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function refreshData() {
            loadTasks();
        }

        // Init
        loadTasks();
        
        // Auto-refresh every 5 minutes
        setInterval(loadTasks, 5 * 60 * 1000);
    </script>
</body>
</html>
