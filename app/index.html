<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center - Decision Queue</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .card-enter { animation: slideIn 0.3s ease-out; }
        .priority-high { border-left: 4px solid #ef4444; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #6b7280; }
        .glow-green { box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); }
    </style>
</head>
<body class="text-gray-100 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                    <span class="text-3xl">‚ö°</span> Command Center
                </h1>
                <p class="text-gray-400 text-sm mt-1">Decisions train your AI. Every choice makes recommendations smarter.</p>
            </div>
            <div class="flex gap-2 items-center">
                <div id="stats" class="text-sm text-gray-400 mr-4"></div>
                <button onclick="showDecisionLog()" class="px-3 py-2 bg-purple-600/30 hover:bg-purple-600/50 rounded-lg text-sm border border-purple-500/30">
                    üìä Decision Log
                </button>
                <button onclick="refreshData()" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">
                    ‚Üª Refresh
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <div class="bg-red-500/20 border border-red-500/30 rounded-lg p-4">
                <div id="highCount" class="text-2xl font-bold text-red-400">-</div>
                <div class="text-xs text-gray-400">High Priority</div>
            </div>
            <div class="bg-yellow-500/20 border border-yellow-500/30 rounded-lg p-4">
                <div id="mediumCount" class="text-2xl font-bold text-yellow-400">-</div>
                <div class="text-xs text-gray-400">Medium Priority</div>
            </div>
            <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
                <div id="resolvedCount" class="text-2xl font-bold text-green-400">-</div>
                <div class="text-xs text-gray-400">Resolved Today</div>
            </div>
            <div class="bg-blue-500/20 border border-blue-500/30 rounded-lg p-4">
                <div id="pipelineValue" class="text-2xl font-bold text-blue-400">-</div>
                <div class="text-xs text-gray-400">Pipeline at Risk</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="flex gap-3 mb-6 flex-wrap bg-gray-800/50 rounded-lg p-3">
            <select id="filterType" onchange="filterDecisions()" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                <option value="">All Types</option>
            </select>
            <select id="filterPriority" onchange="filterDecisions()" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                <option value="">All Priorities</option>
                <option value="high">üî¥ High</option>
                <option value="medium">üü° Medium</option>
                <option value="low">‚ö™ Low</option>
            </select>
            <input type="text" id="searchBox" onkeyup="filterDecisions()" placeholder="Search..." 
                   class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm flex-1 min-w-[200px]">
            <label class="flex items-center gap-2 text-sm text-gray-400 cursor-pointer">
                <input type="checkbox" id="hideResolved" onchange="filterDecisions()" class="rounded bg-gray-700">
                Hide resolved
            </label>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Decision Cards (2 cols) -->
            <div class="lg:col-span-2">
                <div id="decisionList" class="space-y-3"></div>
                <div id="emptyState" class="hidden text-center py-16 bg-gray-800/30 rounded-lg">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h2 class="text-xl font-semibold">All caught up!</h2>
                    <p class="text-gray-400">No decisions need your attention right now.</p>
                </div>
            </div>

            <!-- Sidebar (1 col) -->
            <div class="space-y-4">
                <!-- AI Recommendation -->
                <div id="aiPanel" class="bg-gradient-to-br from-purple-900/30 to-blue-900/30 border border-purple-500/30 rounded-lg p-4">
                    <h3 class="font-semibold flex items-center gap-2 mb-3">
                        <span>üß†</span> AI Recommendation
                    </h3>
                    <div id="aiRecommendation" class="text-sm text-gray-300">
                        Select a decision to see AI recommendations based on your past choices.
                    </div>
                </div>

                <!-- Recent Decisions -->
                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                    <h3 class="font-semibold flex items-center gap-2 mb-3">
                        <span>üìã</span> Recent Decisions
                    </h3>
                    <div id="recentDecisions" class="space-y-2 text-sm max-h-64 overflow-y-auto">
                        <div class="text-gray-500">Loading...</div>
                    </div>
                </div>

                <!-- Learning Stats -->
                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                    <h3 class="font-semibold flex items-center gap-2 mb-3">
                        <span>üìà</span> Learning Stats
                    </h3>
                    <div id="learningStats" class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Total decisions logged</span>
                            <span id="totalDecisions">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Most common action</span>
                            <span id="commonAction">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Avg decisions/day</span>
                            <span id="avgDecisions">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Decision Log Modal -->
    <div id="logModal" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h2 class="text-xl font-bold">Decision Log - Training Data</h2>
                <button onclick="closeLogModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto max-h-[60vh]">
                <div id="logContent" class="space-y-3"></div>
            </div>
            <div class="p-4 border-t border-gray-700 flex justify-between">
                <button onclick="exportLog()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm">
                    üì• Export as JSON
                </button>
                <button onclick="clearLog()" class="px-4 py-2 bg-red-600/50 hover:bg-red-600 rounded-lg text-sm">
                    üóëÔ∏è Clear Log
                </button>
            </div>
        </div>
    </div>

    <script>
        let allDecisions = [];
        let currentDecision = null;
        const STORAGE_KEYS = {
            resolved: 'cc_resolved',
            log: 'cc_decisionLog',
            notes: 'cc_notes'
        };

        const typeLabels = {
            'pricing_visit_no_followup': 'üí∞ Pricing Visit',
            'trial_expiring': '‚è∞ Trial Expiring',
            'email_engagement_no_reply': 'üìß Email Engaged',
            'stalled_deal': 'üßä Stalled Deal',
            'renewal_approaching': 'üîÑ Renewal Due',
            'intent_signal': 'üéØ Intent Signal',
            'no_show_pattern': 'üëª No-Show',
            'sequence_ended_no_response': 'üì¨ Sequence Ended',
            'follow_up': 'üìû Follow Up',
            'pricing_objection': 'üíµ Pricing Issue'
        };

        function getResolved() { return JSON.parse(localStorage.getItem(STORAGE_KEYS.resolved) || '[]'); }
        function getLog() { return JSON.parse(localStorage.getItem(STORAGE_KEYS.log) || '[]'); }
        function getNotes() { return JSON.parse(localStorage.getItem(STORAGE_KEYS.notes) || '{}'); }

        async function loadDecisions() {
            try {
                // Try multiple sources
                let decisions = [];
                
                try {
                    const r1 = await fetch('/data/decisions-queue.json');
                    if (r1.ok) decisions = decisions.concat(await r1.json());
                } catch(e) {}
                
                try {
                    const r2 = await fetch('/src/data/decisions.json');
                    if (r2.ok) {
                        const d2 = await r2.json();
                        if (d2.pendingDecisions) decisions = decisions.concat(d2.pendingDecisions);
                    }
                } catch(e) {}

                // Filter out noise
                allDecisions = decisions.filter(d => d.type !== 'unworked_high_priority');
                
                populateFilters();
                filterDecisions();
                updateStats();
                updateRecentDecisions();
                updateLearningStats();
            } catch (e) {
                console.error('Load error:', e);
            }
        }

        function populateFilters() {
            const types = [...new Set(allDecisions.map(d => d.type))];
            const select = document.getElementById('filterType');
            select.innerHTML = '<option value="">All Types</option>';
            types.forEach(t => {
                const label = typeLabels[t] || t;
                select.innerHTML += `<option value="${t}">${label}</option>`;
            });
        }

        function filterDecisions() {
            const typeFilter = document.getElementById('filterType').value;
            const priorityFilter = document.getElementById('filterPriority').value;
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const hideResolved = document.getElementById('hideResolved').checked;
            const resolved = getResolved();

            let filtered = allDecisions.filter(d => {
                const id = d.contact_id || d.id;
                if (typeFilter && d.type !== typeFilter) return false;
                if (priorityFilter && d.priority !== priorityFilter) return false;
                if (searchTerm) {
                    const searchable = `${d.contact || ''} ${d.company || ''} ${d.email || ''}`.toLowerCase();
                    if (!searchable.includes(searchTerm)) return false;
                }
                if (hideResolved && resolved.includes(id)) return false;
                return true;
            });

            renderDecisions(filtered);
            window.filteredDecisions = filtered;
        }

        function renderDecisions(decisions) {
            const container = document.getElementById('decisionList');
            const emptyState = document.getElementById('emptyState');
            const resolved = getResolved();
            const notes = getNotes();

            if (decisions.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            container.innerHTML = decisions.map((d, idx) => {
                const id = d.contact_id || d.id;
                const isResolved = resolved.includes(id);
                const note = notes[id] || '';
                const typeLabel = typeLabels[d.type] || d.type;
                const options = d.options || d.suggestedActions?.map(a => a.label) || ['Pursue', 'Defer', 'Close'];

                return `
                    <div class="card-enter bg-gray-800/70 rounded-lg p-4 priority-${d.priority} cursor-pointer hover:bg-gray-800 transition ${isResolved ? 'opacity-40' : ''}" 
                         data-id="${id}" onclick="selectDecision(${idx})">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-0.5 text-xs rounded ${d.priority === 'high' ? 'bg-red-500/30 text-red-400' : d.priority === 'medium' ? 'bg-yellow-500/30 text-yellow-400' : 'bg-gray-500/30 text-gray-400'}">
                                    ${d.priority?.toUpperCase() || 'MEDIUM'}
                                </span>
                                <span class="text-xs text-gray-500">${typeLabel}</span>
                            </div>
                            ${isResolved ? '<span class="text-green-500 text-xs">‚úì Resolved</span>' : ''}
                        </div>
                        
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="font-semibold">${d.question || d.context || 'Decision needed'}</h3>
                            ${d.deal_value ? `<span class="text-green-400 font-bold">$${d.deal_value.toLocaleString()}</span>` : ''}
                        </div>
                        ${d.calendar_context ? `<div class="text-xs ${d.has_upcoming_meeting ? 'text-yellow-400 font-semibold' : 'text-gray-500'} mb-2">${d.calendar_context}</div>` : ''}
                        <p class="text-sm text-gray-400 mb-3">${d.signal || d.company || ''}</p>
                        
                        <div class="flex flex-wrap gap-2">
                            ${options.map(opt => `
                                <button onclick="event.stopPropagation(); makeDecision('${id}', '${typeof opt === 'string' ? opt : opt.label}', ${idx})" 
                                        class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm transition">
                                    ${typeof opt === 'string' ? opt : opt.label}
                                </button>
                            `).join('')}
                        </div>
                        
                        ${d.packet_context ? `<div class="mt-2 p-2 bg-gray-700/50 rounded text-xs text-gray-400 max-h-20 overflow-hidden hover:max-h-none transition-all">üìã ${d.packet_context.substring(0, 200)}...</div>` : ''}
                        ${note ? `<div class="mt-2 text-xs text-gray-500 italic">üìù ${note}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function selectDecision(idx) {
            currentDecision = window.filteredDecisions[idx];
            showAIRecommendation(currentDecision);
        }

        function showAIRecommendation(decision) {
            const log = getLog();
            const similar = log.filter(l => l.type === decision.type);
            const panel = document.getElementById('aiRecommendation');
            
            if (similar.length === 0) {
                panel.innerHTML = `
                    <p class="mb-2">No past decisions of this type yet.</p>
                    <p class="text-gray-500 text-xs">Your choice will train future recommendations.</p>
                `;
                return;
            }

            // Count actions
            const actionCounts = {};
            similar.forEach(s => {
                actionCounts[s.action] = (actionCounts[s.action] || 0) + 1;
            });
            
            const sorted = Object.entries(actionCounts).sort((a,b) => b[1] - a[1]);
            const topAction = sorted[0];
            const confidence = Math.round((topAction[1] / similar.length) * 100);

            panel.innerHTML = `
                <p class="mb-2"><strong>Recommended:</strong> ${topAction[0]}</p>
                <p class="text-gray-400 text-xs mb-2">Based on ${similar.length} similar decisions (${confidence}% chose this)</p>
                <div class="text-xs space-y-1">
                    ${sorted.slice(0, 3).map(([action, count]) => `
                        <div class="flex justify-between">
                            <span>${action}</span>
                            <span class="text-gray-500">${count}x</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function makeDecision(id, action, idx) {
            const decision = window.filteredDecisions[idx];
            
            const logEntry = {
                id,
                type: decision.type,
                company: decision.company,
                contact: decision.contact,
                email: decision.email,
                question: decision.question || decision.context,
                signal: decision.signal,
                action,
                timestamp: new Date().toISOString()
            };

            // Log locally
            const log = getLog();
            log.push(logEntry);
            localStorage.setItem(STORAGE_KEYS.log, JSON.stringify(log));

            // Send to backend for persistence + task creation
            try {
                await fetch('/api/decision', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(logEntry)
                });
            } catch(e) {
                console.log('Backend save skipped:', e);
            }

            // Mark resolved
            const resolved = getResolved();
            if (!resolved.includes(id)) {
                resolved.push(id);
                localStorage.setItem(STORAGE_KEYS.resolved, JSON.stringify(resolved));
            }

            // Visual feedback
            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                card.style.transition = 'all 0.3s';
                card.style.transform = 'translateX(50px)';
                card.style.opacity = '0';
                setTimeout(() => {
                    filterDecisions();
                    updateStats();
                    updateRecentDecisions();
                    updateLearningStats();
                }, 300);
            }

            showToast(`‚úì ${action}`);
        }

        function updateStats() {
            const resolved = getResolved();
            const todayLog = getLog().filter(l => l.timestamp?.startsWith(new Date().toISOString().split('T')[0]));
            
            const high = allDecisions.filter(d => d.priority === 'high' && !resolved.includes(d.contact_id || d.id)).length;
            const medium = allDecisions.filter(d => d.priority === 'medium' && !resolved.includes(d.contact_id || d.id)).length;
            
            document.getElementById('highCount').textContent = high;
            document.getElementById('mediumCount').textContent = medium;
            document.getElementById('resolvedCount').textContent = todayLog.length;
            document.getElementById('pipelineValue').textContent = '$245K'; // From earlier analysis
            
            document.getElementById('stats').innerHTML = `${allDecisions.length - resolved.filter(id => allDecisions.some(d => (d.contact_id || d.id) === id)).length} pending`;
        }

        function updateRecentDecisions() {
            const log = getLog().slice(-10).reverse();
            const container = document.getElementById('recentDecisions');
            
            if (log.length === 0) {
                container.innerHTML = '<div class="text-gray-500">No decisions yet</div>';
                return;
            }

            container.innerHTML = log.map(l => `
                <div class="flex justify-between items-center py-1 border-b border-gray-700/50">
                    <div>
                        <div class="font-medium text-xs">${l.company || 'Unknown'}</div>
                        <div class="text-gray-500 text-xs">${l.action}</div>
                    </div>
                    <div class="text-xs text-gray-600">${new Date(l.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</div>
                </div>
            `).join('');
        }

        function updateLearningStats() {
            const log = getLog();
            document.getElementById('totalDecisions').textContent = log.length;
            
            if (log.length > 0) {
                const actionCounts = {};
                log.forEach(l => { actionCounts[l.action] = (actionCounts[l.action] || 0) + 1; });
                const top = Object.entries(actionCounts).sort((a,b) => b[1] - a[1])[0];
                document.getElementById('commonAction').textContent = top ? top[0].substring(0, 15) : '-';
                
                // Avg per day
                const days = new Set(log.map(l => l.timestamp?.split('T')[0])).size || 1;
                document.getElementById('avgDecisions').textContent = (log.length / days).toFixed(1);
            }
        }

        function showDecisionLog() {
            const log = getLog().reverse();
            const container = document.getElementById('logContent');
            
            container.innerHTML = log.map(l => `
                <div class="bg-gray-700/50 rounded p-3">
                    <div class="flex justify-between">
                        <span class="font-semibold">${l.company || 'Unknown'}</span>
                        <span class="text-xs text-gray-500">${new Date(l.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="text-sm text-gray-400 mt-1">${l.question || l.type}</div>
                    <div class="text-sm text-green-400 mt-1">‚Üí ${l.action}</div>
                </div>
            `).join('') || '<div class="text-gray-500">No decisions logged yet</div>';
            
            document.getElementById('logModal').classList.remove('hidden');
        }

        function closeLogModal() {
            document.getElementById('logModal').classList.add('hidden');
        }

        function exportLog() {
            const log = getLog();
            const blob = new Blob([JSON.stringify(log, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `decision-log-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function clearLog() {
            if (confirm('Clear all decision history? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEYS.log);
                localStorage.removeItem(STORAGE_KEYS.resolved);
                closeLogModal();
                filterDecisions();
                updateStats();
                updateRecentDecisions();
                updateLearningStats();
            }
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        function refreshData() {
            loadDecisions();
            showToast('Refreshed');
        }

        // Init
        loadDecisions();
    </script>
</body>
</html>
