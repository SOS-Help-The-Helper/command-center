<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOS | Disaster Relief Coordination</title>
  <meta name="description" content="Connect survivors with resources during disasters">
  
  <!-- Fonts - Roboto per SOS Brand Guide -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Google Places Autocomplete -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCxoRMfrkeV9ah54d_U31oWClJdiy332lc&libraries=places"></script>
  
  <style>
    :root {
      /* SOS Brand Colors - Per Brand Guide */
      --sos-navy: #1A3850;      /* Primary - Trust and reliability */
      --sos-red: #EF4E4B;       /* Secondary - Urgency and importance */
      --sos-red-dark: #D43D3A;
      --sos-blue: #89CFF0;      /* Tertiary - Calm, safety, hope (CTAs) */
      --sos-blue-dark: #6BB5D8;
      --sos-yellow: #FFC107;    /* Warning - Medium urgency */
      --sos-green: #34A853;     /* Success states */
      --sos-orange: #F97316;    /* High urgency */
      --sos-white: #FFFFFF;
      --sos-light: #F9F9F9;     /* Light backgrounds */
      --sos-gray-100: #F7FAFC;
      --sos-gray-200: #EDF2F7;
      --sos-gray-300: #E2E8F0;
      --sos-gray-500: #718096;
      --sos-gray-700: #4A5568;
      --sos-gray-900: #1A202C;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--sos-light);
      color: var(--sos-gray-900);
      min-height: 100vh;
    }
    
    /* ==================== LAYOUT ==================== */
    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .header {
      background: var(--sos-navy);
      color: white;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    
    .logo svg {
      width: 36px;
      height: 36px;
    }
    
    .nav-tabs {
      display: flex;
      gap: 0.5rem;
    }
    
    .nav-tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.7);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .nav-tab:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .nav-tab.active {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    
    .main-content {
      flex: 1;
      position: relative;
    }
    
    /* ==================== VIEW CONTAINERS ==================== */
    .view {
      display: none !important;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--sos-light);
    }
    
    .view.active {
      display: block !important;
      position: relative;
    }
    
    /* ==================== HOME VIEW ==================== */
    .home-view {
      flex-direction: column;
      align-items: center;
      padding: 2rem 1.5rem;
    }
    
    .home-view.active {
      display: flex !important;
    }
    
    .live-stats-banner {
      display: flex;
      justify-content: center;
      gap: 3rem;
      background: var(--sos-navy);
      color: white;
      padding: 1rem 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      width: 100%;
      max-width: 600px;
    }
    
    .live-stat {
      text-align: center;
    }
    
    .live-stat-value {
      display: block;
      font-size: 1.75rem;
      font-weight: 700;
    }
    
    .live-stat-label {
      font-size: 0.75rem;
      opacity: 0.8;
    }
    
    .hero-section {
      text-align: center;
      max-width: 600px;
      margin-bottom: 3rem;
    }
    
    .hero-section h1 {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--sos-navy);
      margin-bottom: 1rem;
      line-height: 1.1;
    }
    
    .hero-section p {
      font-size: 1.125rem;
      color: var(--sos-gray-700);
      line-height: 1.6;
    }
    
    .action-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      width: 100%;
      max-width: 700px;
    }
    
    .action-card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
      text-align: center;
    }
    
    .action-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.12);
    }
    
    .action-card.need {
      border-color: var(--sos-red);
    }
    
    .action-card.need:hover {
      background: rgba(239,78,75,0.05);
    }
    
    .action-card.offer {
      border-color: var(--sos-green);
    }
    
    .action-card.offer:hover {
      background: rgba(52,168,83,0.05);
    }
    
    .action-card-icon {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      font-size: 2rem;
    }
    
    .action-card.need .action-card-icon {
      background: rgba(239,78,75,0.1);
    }
    
    .action-card.offer .action-card-icon {
      background: rgba(52,168,83,0.1);
    }
    
    .action-card h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .action-card.need h2 { color: var(--sos-red); }
    .action-card.offer h2 { color: var(--sos-green); }
    
    .action-card p {
      color: var(--sos-gray-500);
      font-size: 0.95rem;
    }
    
    /* ==================== INTAKE FORM ==================== */
    .intake-view {
      padding: 2rem;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .intake-view.active {
      display: block !important;
    }
    
    .form-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .form-header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .form-header.need h1 { color: var(--sos-red); }
    .form-header.offer h1 { color: var(--sos-green); }
    
    .form-header p {
      color: var(--sos-gray-500);
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--sos-gray-500);
      text-decoration: none;
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
      cursor: pointer;
    }
    
    .back-link:hover {
      color: var(--sos-navy);
    }
    
    .form-card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    
    .form-step {
      display: none;
    }
    
    .form-step.active {
      display: block;
    }
    
    .step-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: var(--sos-navy);
    }
    
    /* Category Grid */
    .category-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    
    .category-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.25rem;
      border: 2px solid var(--sos-gray-200);
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .category-btn:hover {
      border-color: var(--sos-navy);
      background: rgba(26,56,80,0.05);
    }
    
    .category-btn.selected {
      border-color: var(--sos-navy);
      background: rgba(26,56,80,0.1);
    }
    
    .category-btn .icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .category-btn .label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--sos-gray-700);
    }
    
    /* Form Fields */
    .form-group {
      margin-bottom: 1.25rem;
    }
    
    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--sos-gray-700);
      margin-bottom: 0.5rem;
    }
    
    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--sos-gray-200);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    
    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--sos-blue);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    /* Urgency Selector */
    .urgency-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }
    
    .urgency-btn {
      padding: 0.75rem;
      border: 2px solid var(--sos-gray-200);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .urgency-btn.critical {
      color: var(--sos-red);
    }
    .urgency-btn.critical.selected {
      background: var(--sos-red);
      border-color: var(--sos-red);
      color: white;
    }
    
    .urgency-btn.high {
      color: var(--sos-orange);
    }
    .urgency-btn.high.selected {
      background: var(--sos-orange);
      border-color: var(--sos-orange);
      color: white;
    }
    
    .urgency-btn.medium {
      color: var(--sos-yellow);
    }
    .urgency-btn.medium.selected {
      background: var(--sos-yellow);
      border-color: var(--sos-yellow);
      color: var(--sos-navy);
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.875rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .btn-primary {
      background: var(--sos-blue);
      color: var(--sos-navy);
      font-weight: 500;
    }
    
    .btn-primary:hover {
      background: var(--sos-blue-dark);
    }
    
    .btn-primary:disabled {
      background: var(--sos-gray-300);
      cursor: not-allowed;
    }
    
    .btn-need {
      background: var(--sos-red);
      color: white;
    }
    
    .btn-need:hover {
      background: var(--sos-red-dark);
    }
    
    .btn-offer {
      background: var(--sos-green);
      color: white;
    }
    
    .btn-offer:hover {
      background: #2E9448;
    }
    
    .btn-secondary {
      background: var(--sos-gray-200);
      color: var(--sos-gray-700);
    }
    
    .btn-secondary:hover {
      background: var(--sos-gray-300);
    }
    
    .form-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--sos-gray-200);
    }
    
    .form-actions .btn {
      min-width: 120px;
    }
    
    /* Progress Bar */
    .progress-bar {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }
    
    .progress-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--sos-gray-300);
      transition: all 0.3s;
    }
    
    .progress-dot.active {
      background: var(--sos-blue);
      transform: scale(1.2);
    }
    
    .progress-dot.completed {
      background: var(--sos-green);
    }
    
    /* ==================== MAP VIEW ==================== */
    .map-view {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .map-view.active {
      display: flex !important;
    }
    
    #map-container {
      flex: 1;
      min-height: 500px;
    }
    
    .map-controls {
      padding: 1rem;
      background: white;
      border-bottom: 1px solid var(--sos-gray-200);
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .map-filter {
      padding: 0.5rem 1rem;
      border: 1px solid var(--sos-gray-300);
      border-radius: 6px;
      font-size: 0.875rem;
      background: white;
    }
    
    /* Map Legend */
    .map-legend {
      display: flex;
      gap: 1.5rem;
      font-size: 0.875rem;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .legend-dot.request { background: var(--sos-red); }
    .legend-dot.resource { background: var(--sos-green); }
    
    /* ==================== DASHBOARD VIEW ==================== */
    .dashboard-view {
      padding: 2rem;
    }
    
    .dashboard-view.active {
      display: block;
    }
    
    .dashboard-header {
      margin-bottom: 2rem;
    }
    
    .dashboard-header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--sos-navy);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .stat-card h3 {
      font-size: 0.875rem;
      color: var(--sos-gray-500);
      margin-bottom: 0.5rem;
    }
    
    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--sos-navy);
    }
    
    .stat-card .change {
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    
    .stat-card .change.positive { color: var(--sos-green); }
    .stat-card .change.negative { color: var(--sos-red); }
    
    /* Activity Feed */
    .activity-section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .activity-section h2 {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--sos-navy);
    }
    
    .activity-list {
      list-style: none;
    }
    
    .activity-item {
      display: flex;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid var(--sos-gray-200);
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 1.25rem;
    }
    
    .activity-icon.request { background: rgba(239,78,75,0.1); }
    .activity-icon.resource { background: rgba(52,168,83,0.1); }
    .activity-icon.match { background: rgba(74,144,217,0.1); }
    
    .activity-content {
      flex: 1;
    }
    
    .activity-content h4 {
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    
    .activity-content p {
      font-size: 0.85rem;
      color: var(--sos-gray-500);
    }
    
    .activity-time {
      font-size: 0.75rem;
      color: var(--sos-gray-500);
    }
    
    /* ==================== SUCCESS MODAL ==================== */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
      animation: modalSlideUp 0.3s ease;
    }
    
    @keyframes modalSlideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(52,168,83,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      font-size: 2.5rem;
    }
    
    .modal h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--sos-green);
      margin-bottom: 0.5rem;
    }
    
    .modal p {
      color: var(--sos-gray-500);
      margin-bottom: 1.5rem;
    }
    
    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 1rem;
      }
      
      .nav-tabs {
        width: 100%;
        justify-content: center;
      }
      
      .hero-section h1 {
        font-size: 2rem;
      }
      
      .action-cards {
        grid-template-columns: 1fr;
      }
      
      .category-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .urgency-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* ==================== LOADING SPINNER ==================== */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 1001;
    }
    
    .toast {
      background: var(--sos-navy);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      margin-top: 0.5rem;
      animation: toastSlideIn 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .toast.success { background: var(--sos-green); }
    .toast.error { background: var(--sos-red); }
    
    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <svg viewBox="0 0 36 36" fill="none">
          <circle cx="18" cy="18" r="16" fill="#EF4E4B"/>
          <path d="M18 8L20 14H26L21 18L23 24L18 20L13 24L15 18L10 14H16L18 8Z" fill="white"/>
        </svg>
        <span>SOS</span>
      </div>
      <nav class="nav-tabs">
        <button class="nav-tab active" data-view="home">Home</button>
        <button class="nav-tab" data-view="map">Map</button>
        <button class="nav-tab" data-view="dashboard">Dashboard</button>
      </nav>
    </header>
    
    <!-- Main Content -->
    <main class="main-content">
      <!-- HOME VIEW -->
      <section id="home-view" class="view home-view active">
        <!-- Live Stats Banner -->
        <div class="live-stats-banner" id="live-stats-banner">
          <div class="live-stat">
            <span class="live-stat-value" id="home-requests">-</span>
            <span class="live-stat-label">People Seeking Help</span>
          </div>
          <div class="live-stat">
            <span class="live-stat-value" id="home-resources">-</span>
            <span class="live-stat-label">Resources Available</span>
          </div>
          <div class="live-stat">
            <span class="live-stat-value" id="home-matches">-</span>
            <span class="live-stat-label">Matches Made</span>
          </div>
        </div>
        
        <div class="hero-section">
          <h1>Hurricane Helene Relief</h1>
          <p style="color: var(--sos-red); font-weight: 500; margin-bottom: 0.5rem;">üî¥ Active Disaster Response - Western North Carolina</p>
          <p>SOS connects survivors with volunteers and resources. Get help or offer assistance in your community.</p>
        </div>
        
        <div class="action-cards">
          <div class="action-card need" onclick="showIntakeForm('need')">
            <div class="action-card-icon">üÜò</div>
            <h2>I Need Help</h2>
            <p>Request housing, food, medical care, supplies, or volunteer support</p>
          </div>
          
          <div class="action-card offer" onclick="showIntakeForm('offer')">
            <div class="action-card-icon">ü§ù</div>
            <h2>I Can Help</h2>
            <p>Offer resources, volunteer time, or professional services</p>
          </div>
        </div>
      </section>
      
      <!-- INTAKE FORM VIEW -->
      <section id="intake-view" class="view intake-view">
        <span class="back-link" onclick="showView('home')">‚Üê Back to Home</span>
        
        <div class="form-header" id="form-header">
          <h1>Request Help</h1>
          <p>Tell us what you need and we'll connect you with resources</p>
        </div>
        
        <div class="progress-bar">
          <div class="progress-dot active" data-step="1"></div>
          <div class="progress-dot" data-step="2"></div>
          <div class="progress-dot" data-step="3"></div>
          <div class="progress-dot" data-step="4"></div>
        </div>
        
        <div class="form-card">
          <form id="intake-form">
            <!-- Step 1: Category -->
            <div class="form-step active" data-step="1">
              <h3 class="step-title">What type of help do you need?</h3>
              <div class="category-grid">
                <button type="button" class="category-btn" data-category="housing">
                  <span class="icon">üè†</span>
                  <span class="label">Housing</span>
                </button>
                <button type="button" class="category-btn" data-category="food">
                  <span class="icon">üçΩÔ∏è</span>
                  <span class="label">Food</span>
                </button>
                <button type="button" class="category-btn" data-category="medical">
                  <span class="icon">üè•</span>
                  <span class="label">Medical</span>
                </button>
                <button type="button" class="category-btn" data-category="transport">
                  <span class="icon">üöó</span>
                  <span class="label">Transport</span>
                </button>
                <button type="button" class="category-btn" data-category="supplies">
                  <span class="icon">üì¶</span>
                  <span class="label">Supplies</span>
                </button>
                <button type="button" class="category-btn" data-category="volunteer">
                  <span class="icon">üôã</span>
                  <span class="label">Volunteer</span>
                </button>
              </div>
            </div>
            
            <!-- Step 2: Details (dynamically updated based on category + type) -->
            <div class="form-step" data-step="2">
              <h3 class="step-title" id="step2-title">Tell us more</h3>
              
              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="description" placeholder="Describe your situation..." required></textarea>
              </div>
              
              <!-- Category-specific questions inserted here -->
              <div id="category-questions"></div>
              
              <div class="form-group" id="quantity-group">
                <label class="form-label" id="quantity-label">Quantity / Number of People</label>
                <input type="number" class="form-input" id="quantity" placeholder="e.g., 4" min="1">
              </div>
              
              <div class="form-group" id="urgency-group">
                <label class="form-label">Urgency Level</label>
                <div class="urgency-grid">
                  <button type="button" class="urgency-btn critical" data-urgency="critical">üî¥ Critical</button>
                  <button type="button" class="urgency-btn high" data-urgency="high">üü† High</button>
                  <button type="button" class="urgency-btn medium" data-urgency="medium">üü° Medium</button>
                </div>
              </div>
            </div>
            
            <!-- Step 3: Location & Disaster -->
            <div class="form-step" data-step="3">
              <h3 class="step-title">Where are you located?</h3>
              
              <div class="form-group">
                <label class="form-label">Address or Location</label>
                <input type="text" class="form-input" id="location" placeholder="Enter address, city, or landmark" required>
              </div>
              
              <div id="location-map" style="height: 80px; border-radius: 8px; margin-top: 1rem; background: var(--sos-gray-100); display: flex; align-items: center; justify-content: center; color: var(--sos-gray-500); font-size: 0.85rem;">
                <span>üìç Location will be verified by our team</span>
              </div>
              
              <div class="form-group" style="margin-top: 1.5rem;">
                <label class="form-label">Which disaster is this related to?</label>
                <select class="form-input" id="disaster_id" required>
                  <option value="">Select a disaster...</option>
                  <option value="helene-wnc-2024" data-regions="NC,TN,VA,SC,GA">üåÄ Hurricane Helene - WNC (Oct 2024)</option>
                  <option value="winter-storm-fern-2025" data-regions="NC,VA,TN,WV">‚ùÑÔ∏è Winter Storm Fern (Jan 2025)</option>
                  <option value="midwest-floods-2025" data-regions="MO,IL,KY,IN,OH">üåä Midwest Floods (Feb 2025)</option>
                  <option value="ca-wildfires-2025" data-regions="CA">üî• California Wildfires (Jan 2025)</option>
                  <option value="other">üìã Other / Not Listed</option>
                </select>
                <p id="disaster-suggestion" style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--sos-gray-500);"></p>
              </div>
            </div>
            
            <!-- Step 4: Contact -->
            <div class="form-step" data-step="4">
              <h3 class="step-title">How can we reach you?</h3>
              
              <div class="form-group">
                <label class="form-label">Your Name</label>
                <input type="text" class="form-input" id="contact_name" placeholder="Full name" required>
              </div>
              
              <div class="form-group">
                <label class="form-label">Phone Number</label>
                <input type="tel" class="form-input" id="contact_phone" placeholder="(555) 123-4567">
              </div>
              
              <div class="form-group">
                <label class="form-label">Email (optional)</label>
                <input type="email" class="form-input" id="contact_email" placeholder="you@example.com">
              </div>
            </div>
            
            <!-- Form Actions -->
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" id="prev-btn" onclick="prevStep()" style="visibility: hidden;">‚Üê Back</button>
              <button type="button" class="btn btn-primary" id="next-btn" onclick="nextStep()">Continue ‚Üí</button>
              <button type="submit" class="btn btn-need" id="submit-btn" style="display: none;">Submit Request</button>
            </div>
          </form>
        </div>
      </section>
      
      <!-- MAP VIEW -->
      <section id="map-view" class="view map-view">
        <div class="map-controls">
          <select class="map-filter" id="category-filter" onchange="loadMapData()">
            <option value="all">All Categories</option>
            <option value="housing">üè† Housing</option>
            <option value="food">üçΩÔ∏è Food</option>
            <option value="medical">üè• Medical</option>
            <option value="transport">üöó Transport</option>
            <option value="supplies">üì¶ Supplies</option>
            <option value="volunteer">üôã Volunteer</option>
          </select>
          
          <select class="map-filter" id="type-filter" onchange="loadMapData()">
            <option value="all">All Types</option>
            <option value="request">üÜò Requests Only</option>
            <option value="resource">ü§ù Resources Only</option>
          </select>
          
          <button class="btn btn-outline" id="toggle-view-btn" onclick="toggleMapListView()" style="margin-left: auto;">
            üìã List View
          </button>
          
          <div class="map-legend">
            <div class="legend-item">
              <div class="legend-dot request"></div>
              <span>Requests</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot resource"></div>
              <span>Resources</span>
            </div>
          </div>
        </div>
        <div id="map-container"></div>
        <div id="list-container" style="display: none; padding: 1rem; overflow-y: auto; max-height: calc(100vh - 200px);">
          <!-- List view populated by JS -->
        </div>
      </section>
      
      <!-- DASHBOARD VIEW -->
      <section id="dashboard-view" class="view dashboard-view">
        <div class="dashboard-header">
          <h1>Your Dashboard</h1>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Active Requests</h3>
            <div class="value" id="stat-requests">-</div>
          </div>
          <div class="stat-card">
            <h3>Available Resources</h3>
            <div class="value" id="stat-resources">-</div>
          </div>
          <div class="stat-card">
            <h3>Matches Made</h3>
            <div class="value" id="stat-matches">-</div>
          </div>
          <div class="stat-card">
            <h3>People Helped</h3>
            <div class="value" id="stat-helped">-</div>
          </div>
        </div>
        
        <div class="activity-section">
          <h2>Recent Activity</h2>
          <ul class="activity-list" id="activity-list">
            <li class="activity-item">
              <div class="activity-icon request">üÜò</div>
              <div class="activity-content">
                <h4>Loading activity...</h4>
                <p>Please wait</p>
              </div>
            </li>
          </ul>
        </div>
      </section>
    </main>
  </div>
  
  <!-- Success Modal -->
  <div class="modal-overlay" id="success-modal">
    <div class="modal">
      <div class="modal-icon">‚úì</div>
      <h2>Submitted!</h2>
      <p>Your request has been received. We'll notify you when we find a match.</p>
      <button class="btn btn-primary" onclick="closeModal()">Got it</button>
    </div>
  </div>
  
  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>
  
  <script>
    // ==================== SUPABASE CONFIG ====================
    const SUPABASE_URL = 'https://rtduqguwhkczexnoawej.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0ZHVxZ3V3aGtjemV4bm9hd2VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2Njg1ODAsImV4cCI6MjA2NzI0NDU4MH0.1QZ5ofS-ND_OI71igPlxxMTyZJJRlATSSC0djccWR8o';
    
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ==================== MAPBOX CONFIG ====================
    const MAPBOX_TOKEN = 'pk.eyJ1Ijoic29zY29ubmVjdCIsImEiOiJjbTh0bWxtMXYwY2NpMmxwbnduaGVtZHpxIn0._Bf7tss1pTHIcSH0t_FaTQ';
    let map = null;
    
    // ==================== STATE ====================
    let currentView = 'home';
    let intakeType = 'need'; // 'need' or 'offer'
    let currentStep = 1;
    let formData = {
      categories: [], // Changed to array for multi-select
      description: '',
      quantity: 1,
      urgency: 'medium',
      location: '',
      lat: null,
      lng: null,
      contact_name: '',
      contact_phone: '',
      contact_email: ''
    };
    
    // ==================== DISASTER TRACKING ====================
    // Get disaster ID from URL param (?disaster=helene-wnc-2024) or default
    const urlParams = new URLSearchParams(window.location.search);
    const DISASTER_ID = urlParams.get('disaster') || 'helene-wnc-2024';
    console.log('Active disaster:', DISASTER_ID);
    
    // ==================== VIEW NAVIGATION ====================
    function showView(viewName) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      
      document.getElementById(viewName + '-view').classList.add('active');
      document.querySelector(`[data-view="${viewName}"]`)?.classList.add('active');
      
      currentView = viewName;
      
      // Immersive mode for intake - hide nav
      const navTabs = document.querySelector('.nav-tabs');
      if (viewName === 'intake') {
        navTabs.style.display = 'none';
        document.body.style.background = 'linear-gradient(135deg, var(--sos-gray-100) 0%, var(--sos-white) 100%)';
      } else {
        navTabs.style.display = 'flex';
        document.body.style.background = 'var(--sos-light)';
      }
      
      if (viewName === 'map' && !map) {
        initMap();
      }
      if (viewName === 'dashboard') {
        loadDashboardData();
      }
    }
    
    // Nav tab clicks - wrapped in DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => showView(tab.dataset.view));
      });
      
      // Category button clicks - multi-select toggle
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const cat = btn.dataset.category;
          btn.classList.toggle('selected');
          
          if (btn.classList.contains('selected')) {
            if (!formData.categories.includes(cat)) {
              formData.categories.push(cat);
            }
          } else {
            formData.categories = formData.categories.filter(c => c !== cat);
          }
          
          // Update Continue button state
          const nextBtn = document.getElementById('next-btn');
          if (formData.categories.length > 0) {
            nextBtn.disabled = false;
            nextBtn.textContent = formData.categories.length > 1 
              ? `Continue with ${formData.categories.length} needs ‚Üí` 
              : 'Continue ‚Üí';
          } else {
            nextBtn.disabled = true;
            nextBtn.textContent = 'Select at least one ‚Üí';
          }
        });
      });
      
      // Urgency button clicks
      document.querySelectorAll('.urgency-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.urgency-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          formData.urgency = btn.dataset.urgency;
        });
      });
      
      // Load initial stats
      loadHomeStats();
      
      // Initialize Google Places Autocomplete
      const locationInput = document.getElementById('location');
      if (locationInput && window.google && window.google.maps) {
        const autocomplete = new google.maps.places.Autocomplete(locationInput, {
          types: ['geocode'],
          componentRestrictions: { country: 'us' },
          fields: ['formatted_address', 'geometry', 'name']
        });
        
        autocomplete.addListener('place_changed', () => {
          const place = autocomplete.getPlace();
          if (place.geometry) {
            formData.lat = place.geometry.location.lat();
            formData.lng = place.geometry.location.lng();
            formData.location = place.formatted_address || place.name;
            locationInput.value = formData.location;
            console.log('Location selected:', formData.location, formData.lat, formData.lng);
            
            // Auto-suggest disaster based on location
            suggestDisaster(formData.location);
          }
        });
        console.log('Google Places Autocomplete initialized');
      }
      
      console.log('SOS Frontend initialized');
    });
    
    // ==================== DISASTER SUGGESTION ====================
    function suggestDisaster(location) {
      const disasterSelect = document.getElementById('disaster_id');
      const suggestionEl = document.getElementById('disaster-suggestion');
      if (!disasterSelect || !location) return;
      
      const locationUpper = location.toUpperCase();
      let suggestedValue = '';
      let suggestionText = '';
      
      // Check location against disaster regions
      if (locationUpper.includes('NC') || locationUpper.includes('NORTH CAROLINA') || 
          locationUpper.includes('ASHEVILLE') || locationUpper.includes('BURNSVILLE') ||
          locationUpper.includes('BUNCOMBE') || locationUpper.includes('YANCEY')) {
        suggestedValue = 'helene-wnc-2024';
        suggestionText = 'üí° Based on your location, this appears related to Hurricane Helene';
      } else if (locationUpper.includes('CA') || locationUpper.includes('CALIFORNIA') ||
                 locationUpper.includes('LOS ANGELES') || locationUpper.includes('MALIBU')) {
        suggestedValue = 'ca-wildfires-2025';
        suggestionText = 'üí° Based on your location, this may be related to the California Wildfires';
      } else if (locationUpper.includes('MO') || locationUpper.includes('MISSOURI') ||
                 locationUpper.includes('IL') || locationUpper.includes('ILLINOIS') ||
                 locationUpper.includes('KENTUCKY') || locationUpper.includes('KY')) {
        suggestedValue = 'midwest-floods-2025';
        suggestionText = 'üí° Based on your location, this may be related to the Midwest Floods';
      }
      
      if (suggestedValue) {
        disasterSelect.value = suggestedValue;
        suggestionEl.innerHTML = suggestionText;
      } else {
        suggestionEl.innerHTML = '';
      }
    }
    
    // ==================== INTAKE FORM ====================
    function showIntakeForm(type) {
      intakeType = type;
      currentStep = 1;
      formData = {
        categories: [],
        description: '',
        quantity: 1,
        urgency: 'medium',
        location: '',
        lat: null,
        lng: null,
        disaster_id: '',
        contact_name: '',
        contact_phone: '',
        contact_email: ''
      };
      
      // Reset Continue button state for multi-select
      const nextBtn = document.getElementById('next-btn');
      nextBtn.disabled = true;
      nextBtn.textContent = 'Select at least one ‚Üí';
      
      // Update header
      const header = document.getElementById('form-header');
      if (type === 'need') {
        header.className = 'form-header need';
        header.querySelector('h1').textContent = 'Request Help';
        header.querySelector('p').textContent = 'Tell us what you need and we\'ll connect you with resources';
        document.getElementById('submit-btn').className = 'btn btn-need';
        document.getElementById('submit-btn').textContent = 'Submit Request';
        document.querySelector('.step-title').textContent = 'What type of help do you need? (select all that apply)';
      } else {
        header.className = 'form-header offer';
        header.querySelector('h1').textContent = 'Offer Help';
        header.querySelector('p').textContent = 'Share what you can provide to help your community';
        document.getElementById('submit-btn').className = 'btn btn-offer';
        document.getElementById('submit-btn').textContent = 'Submit Offer';
        document.querySelector('.step-title').textContent = 'What type of help can you offer? (select all that apply)';
      }
      
      // Reset form UI
      updateProgressBar();
      updateStepVisibility();
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
      document.querySelectorAll('.urgency-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector('.urgency-btn.medium').classList.add('selected');
      document.getElementById('intake-form').reset();
      
      showView('intake');
    }
    
    function updateProgressBar() {
      document.querySelectorAll('.progress-dot').forEach((dot, i) => {
        dot.classList.remove('active', 'completed');
        if (i + 1 < currentStep) dot.classList.add('completed');
        if (i + 1 === currentStep) dot.classList.add('active');
      });
    }
    
    function updateStepVisibility() {
      document.querySelectorAll('.form-step').forEach((step, i) => {
        step.classList.toggle('active', i + 1 === currentStep);
      });
      
      // Update buttons
      document.getElementById('prev-btn').style.visibility = currentStep > 1 ? 'visible' : 'hidden';
      document.getElementById('next-btn').style.display = currentStep < 4 ? 'inline-flex' : 'none';
      document.getElementById('submit-btn').style.display = currentStep === 4 ? 'inline-flex' : 'none';
    }
    
    // Update step 2 based on intake type and categories
    function updateStep2Content() {
      const isRequest = intakeType === 'need';
      const cats = formData.categories;
      
      // Update title and description placeholder
      document.getElementById('step2-title').textContent = isRequest 
        ? 'Tell us more about your situation' 
        : 'Tell us what you can provide';
      
      document.getElementById('description').placeholder = isRequest
        ? 'Describe your situation and what you need...'
        : 'Describe what you can offer and any conditions...';
      
      // Update quantity label based on category
      const quantityLabel = document.getElementById('quantity-label');
      const quantityInput = document.getElementById('quantity');
      
      if (cats.includes('housing')) {
        quantityLabel.textContent = isRequest ? 'Number of People' : 'How many people can you accommodate?';
        quantityInput.placeholder = 'e.g., 4';
      } else if (cats.includes('food')) {
        quantityLabel.textContent = isRequest ? 'Number of People to Feed' : 'Meals Available (per day)';
        quantityInput.placeholder = isRequest ? 'e.g., 4' : 'e.g., 50';
      } else if (cats.includes('supplies')) {
        quantityLabel.textContent = isRequest ? 'Quantity Needed' : 'Quantity Available';
        quantityInput.placeholder = 'e.g., 10';
      } else {
        quantityLabel.textContent = isRequest ? 'Number of People' : 'Capacity';
        quantityInput.placeholder = 'e.g., 4';
      }
      
      // Hide urgency for offers (resources don't have urgency)
      document.getElementById('urgency-group').style.display = isRequest ? 'block' : 'none';
      
      // Add category-specific questions
      let extraQuestions = '';
      
      if (cats.includes('housing')) {
        extraQuestions += `
          <div class="form-group">
            <label class="form-label">${isRequest ? 'Housing type needed' : 'What type of housing can you offer?'}</label>
            <select class="form-select" id="housing-subtype">
              <option value="">Select type</option>
              <option value="rv">üöê RV/Camper</option>
              <option value="shelter">üèïÔ∏è Emergency Shelter</option>
              <option value="hotel">üè® Hotel/Motel</option>
              <option value="host_family">üë®‚Äçüë©‚Äçüëß Host Family/Spare Room</option>
              <option value="rental">üè° Temporary Rental</option>
              <option value="repairs">üîß Home Repairs Needed</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">${isRequest ? 'How long do you need housing?' : 'How long can you provide housing?'}</label>
            <select class="form-select" id="housing-duration">
              <option value="">Select timeframe</option>
              <option value="days">A few days</option>
              <option value="1-2weeks">1-2 weeks</option>
              <option value="month">About a month</option>
              <option value="longterm">Long-term (1+ months)</option>
            </select>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label class="form-label">Adults</label>
              <input type="number" class="form-input" id="housing-adults" min="1" max="20" placeholder="1" value="1">
            </div>
            <div class="form-group">
              <label class="form-label">Children</label>
              <input type="number" class="form-input" id="housing-children" min="0" max="20" placeholder="0" value="0">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">${isRequest ? 'Do you have pets?' : 'Can you accommodate pets?'}</label>
            <select class="form-select" id="pets-type">
              <option value="none">No pets</option>
              <option value="dogs">Dog(s)</option>
              <option value="cats">Cat(s)</option>
              <option value="multiple">Multiple/Other pets</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">${isRequest ? 'Accessibility needs?' : 'Accessibility features?'}</label>
            <select class="form-select" id="housing-accessibility">
              <option value="none">No special needs</option>
              <option value="wheelchair">Wheelchair accessible</option>
              <option value="ground_floor">Ground floor only</option>
              <option value="medical_equipment">Space for medical equipment</option>
            </select>
          </div>
        `;
      }
      
      if (cats.includes('transport')) {
        extraQuestions += `
          <div class="form-group">
            <label class="form-label">${isRequest ? 'What type of transport do you need?' : 'What can you offer?'}</label>
            <select class="form-select" id="transport-subtype">
              <option value="">Select type</option>
              <option value="ride">üöê Ride/Shuttle</option>
              <option value="evacuation">üö® Evacuation</option>
              <option value="moving">üì¶ Help Moving Belongings</option>
              <option value="vehicle_loan">üîë Vehicle Loan</option>
              <option value="fuel">‚õΩ Fuel/Gas Assistance</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">${isRequest ? 'When do you need transport?' : 'When are you available?'}</label>
            <select class="form-select" id="transport-when">
              <option value="">Select timing</option>
              <option value="asap">As soon as possible</option>
              <option value="today">Today</option>
              <option value="tomorrow">Tomorrow</option>
              <option value="this_week">This week</option>
              <option value="flexible">Flexible</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">${isRequest ? 'Number of passengers' : 'Passenger capacity'}</label>
            <input type="number" class="form-input" id="transport-passengers" min="1" max="50" placeholder="1">
          </div>
          <div class="form-group">
            <label class="form-label">Special requirements</label>
            <select class="form-select" id="transport-special">
              <option value="none">None</option>
              <option value="wheelchair">Wheelchair accessible</option>
              <option value="large_items">Large items / Cargo space</option>
              <option value="child_seat">Car seat needed</option>
              <option value="pets">Pets</option>
            </select>
          </div>
        `;
      }
      
      if (cats.includes('medical')) {
        extraQuestions += `
          <div class="form-group">
            <label class="form-label">${isRequest ? 'What type of medical need?' : 'What medical help can you provide?'}</label>
            <select class="form-select" id="medical-type">
              <option value="">Select type</option>
              <option value="first_aid">ü©π First Aid / Minor Injury</option>
              <option value="prescriptions">üíä Prescription Refill</option>
              <option value="equipment">ü¶Ω Medical Equipment</option>
              <option value="mental_health">üß† Mental Health / Counseling</option>
              <option value="transport_medical">üöë Transport to Medical Facility</option>
              <option value="chronic">Chronic Condition Care</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">${isRequest ? 'Your mobility status' : 'Can you serve patients with limited mobility?'}</label>
            <select class="form-select" id="medical-mobility">
              <option value="mobile">Fully mobile</option>
              <option value="limited">Limited mobility</option>
              <option value="wheelchair">Wheelchair user</option>
              <option value="bedridden">Cannot travel</option>
            </select>
          </div>
        `;
      }
      
      if (cats.includes('food')) {
        extraQuestions += `
          <div class="form-group">
            <label class="form-label">${isRequest ? 'What type of food assistance?' : 'What can you provide?'}</label>
            <select class="form-select" id="food-subtype">
              <option value="">Select type</option>
              <option value="hot_meals">üç≤ Hot Meals</option>
              <option value="groceries">üõí Groceries</option>
              <option value="baby_formula">üçº Baby Formula/Food</option>
              <option value="water">üíß Water/Drinks</option>
              <option value="special_diet">ü•ó Special Diet</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">${isRequest ? 'How often do you need food?' : 'How often can you provide?'}</label>
            <select class="form-select" id="food-frequency">
              <option value="one_time">One-time / Emergency</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="ongoing">Ongoing support</option>
            </select>
          </div>
        `;
      }
      
      if (cats.includes('supplies')) {
        extraQuestions += `
          <div class="form-group">
            <label class="form-label">${isRequest ? 'What type of supplies?' : 'What supplies can you provide?'}</label>
            <select class="form-select" id="supplies-subtype">
              <option value="">Select type</option>
              <option value="clothing">üëï Clothing</option>
              <option value="hygiene">üß¥ Hygiene/Toiletries</option>
              <option value="baby">üë∂ Baby Supplies</option>
              <option value="cleaning">üßπ Cleaning Supplies</option>
              <option value="tools">üî® Tools</option>
              <option value="building">ü™µ Building Materials</option>
              <option value="furniture">üõãÔ∏è Furniture</option>
            </select>
          </div>
        `;
      }
      
      if (cats.includes('volunteer')) {
        extraQuestions += `
          <div class="form-group">
            <label class="form-label">${isRequest ? 'What type of help do you need?' : 'What skills can you offer?'}</label>
            <select class="form-select" id="volunteer-subtype">
              <option value="">Select type</option>
              <option value="debris">üí™ Debris Removal / Cleanup</option>
              <option value="tree">ü™ì Tree/Chainsaw Work</option>
              <option value="construction">üî® Construction / Repairs</option>
              <option value="electrical">‚ö° Electrical Work</option>
              <option value="plumbing">üîß Plumbing</option>
              <option value="childcare">üë∂ Childcare</option>
              <option value="admin">üìã Admin / Coordination</option>
              <option value="general">General Labor</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">${isRequest ? 'How many volunteers needed?' : 'How many people in your group?'}</label>
            <input type="number" class="form-input" id="volunteer-count" min="1" max="100" placeholder="1">
          </div>
        `;
      }
      
      document.getElementById('category-questions').innerHTML = extraQuestions;
    }
    
    function nextStep() {
      // Validation
      if (currentStep === 1 && formData.categories.length === 0) {
        showToast('Please select at least one category', 'error');
        return;
      }
      if (currentStep === 2 && !document.getElementById('description').value.trim()) {
        showToast('Please describe your situation', 'error');
        return;
      }
      if (currentStep === 3 && !document.getElementById('location').value.trim()) {
        showToast('Please enter a location', 'error');
        return;
      }
      if (currentStep === 3 && !document.getElementById('disaster_id').value) {
        showToast('Please select which disaster this relates to', 'error');
        return;
      }
      
      // Save step data
      if (currentStep === 2) {
        formData.description = document.getElementById('description').value;
        formData.quantity = parseInt(document.getElementById('quantity').value) || 1;
        
        // Housing-specific fields
        formData.housingSubtype = document.getElementById('housing-subtype')?.value || null;
        formData.housingDuration = document.getElementById('housing-duration')?.value || null;
        formData.housingAdults = parseInt(document.getElementById('housing-adults')?.value) || null;
        formData.housingChildren = parseInt(document.getElementById('housing-children')?.value) || null;
        formData.petsType = document.getElementById('pets-type')?.value || null;
        formData.housingAccessibility = document.getElementById('housing-accessibility')?.value || null;
        
        // Transport-specific fields
        formData.transportSubtype = document.getElementById('transport-subtype')?.value || null;
        formData.transportWhen = document.getElementById('transport-when')?.value || null;
        formData.transportPassengers = parseInt(document.getElementById('transport-passengers')?.value) || null;
        formData.transportSpecial = document.getElementById('transport-special')?.value || null;
        
        // Medical-specific fields
        formData.medicalType = document.getElementById('medical-type')?.value || null;
        formData.medicalMobility = document.getElementById('medical-mobility')?.value || null;
        
        // Food-specific fields
        formData.foodSubtype = document.getElementById('food-subtype')?.value || null;
        formData.foodFrequency = document.getElementById('food-frequency')?.value || null;
        
        // Supplies-specific fields
        formData.suppliesSubtype = document.getElementById('supplies-subtype')?.value || null;
        
        // Volunteer-specific fields
        formData.volunteerSubtype = document.getElementById('volunteer-subtype')?.value || null;
        formData.volunteerCount = parseInt(document.getElementById('volunteer-count')?.value) || null;
      }
      if (currentStep === 3) {
        formData.location = document.getElementById('location').value;
        formData.disaster_id = document.getElementById('disaster_id').value;
      }
      
      // Update step 2 content when moving from step 1
      if (currentStep === 1) {
        updateStep2Content();
      }
      
      currentStep++;
      updateProgressBar();
      updateStepVisibility();
    }
    
    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        updateProgressBar();
        updateStepVisibility();
      }
    }
    
    // Category and urgency selection - moved to DOMContentLoaded above
    
    // Form submission
    document.getElementById('intake-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Gather final data
      formData.contact_name = document.getElementById('contact_name').value;
      formData.contact_phone = document.getElementById('contact_phone').value;
      formData.contact_email = document.getElementById('contact_email').value;
      
      if (!formData.contact_name || (!formData.contact_phone && !formData.contact_email)) {
        showToast('Please provide your name and at least one contact method', 'error');
        return;
      }
      
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span> Submitting...';
      
      try {
        // Create intake record - use form-selected disaster or URL param fallback
        const selectedDisaster = formData.disaster_id || DISASTER_ID;
        const intake = {
          source: 'web',
          source_id: `web:${Date.now()}`,
          intake_type: intakeType === 'need' ? 'request' : 'resource',
          status: 'pending',
          raw_data: formData,
          contact_name: formData.contact_name,
          contact_phone: formData.contact_phone,
          contact_email: formData.contact_email,
          disaster_id: selectedDisaster
        };
        
        const { data, error } = await db
          .from('intakes')
          .insert([intake])
          .select();
        
        if (error) throw error;
        
        console.log('Intake created:', data);
        
        // Create request or resource for EACH selected category
        for (const category of formData.categories) {
          if (intakeType === 'need') {
            const request = {
              intake_id: data[0].id,
              disaster_id: selectedDisaster,
              status: 'active',
              need_type_id: category,
              title: `${category}: ${formData.description.substring(0, 50)}`,
              description: formData.description,
              urgency: formData.urgency,
              quantity_needed: formData.quantity,
              location_description: formData.location,
              contact_name: formData.contact_name,
              contact_phone: formData.contact_phone,
              contact_email: formData.contact_email,
              intake_source: 'web'
            };
            
            const { error: reqError } = await db
              .from('requests')
              .insert([request]);
            
            if (reqError) throw reqError;
          } else {
            const resource = {
              intake_id: data[0].id,
              disaster_id: selectedDisaster,
              status: 'active',
              resource_type_id: category,
              title: `${category}: ${formData.description.substring(0, 50)}`,
              description: formData.description,
              quantity_available: formData.quantity,
              location_description: formData.location,
              contact_name: formData.contact_name,
              contact_phone: formData.contact_phone,
              intake_source: 'web'
            };
            
            const { error: resError } = await db
              .from('resources')
              .insert([resource]);
            
            if (resError) throw resError;
          }
        }
        
        // Update intake status
        await db
          .from('intakes')
          .update({ status: 'processed' })
          .eq('id', data[0].id);
        
        // Show success
        document.getElementById('success-modal').classList.add('active');
        
      } catch (err) {
        console.error('Submission error:', err);
        showToast('Failed to submit. Please try again.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = intakeType === 'need' ? 'Submit Request' : 'Submit Offer';
      }
    });
    
    function closeModal() {
      document.getElementById('success-modal').classList.remove('active');
      showView('home');
    }
    
    // ==================== MAP ====================
    let markers = [];
    
    function initMap() {
      if (!MAPBOX_TOKEN) {
        document.getElementById('map-container').innerHTML = `
          <div style="height:100%;display:flex;align-items:center;justify-content:center;background:var(--sos-gray-200);">
            <p style="color:var(--sos-gray-500);">Map requires Mapbox API key.</p>
          </div>
        `;
        return;
      }
      
      mapboxgl.accessToken = MAPBOX_TOKEN;
      map = new mapboxgl.Map({
        container: 'map-container',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [-82.30, 35.92], // Burnsville, NC
        zoom: 9
      });
      
      map.addControl(new mapboxgl.NavigationControl(), 'top-right');
      
      map.on('load', () => {
        loadMapData();
      });
    }
    
    let mapListView = false; // false = map, true = list
    
    function toggleMapListView() {
      mapListView = !mapListView;
      const btn = document.getElementById('toggle-view-btn');
      const mapContainer = document.getElementById('map-container');
      const listContainer = document.getElementById('list-container');
      
      if (mapListView) {
        btn.innerHTML = 'üó∫Ô∏è Map View';
        mapContainer.style.display = 'none';
        listContainer.style.display = 'block';
        loadListView();
      } else {
        btn.innerHTML = 'üìã List View';
        mapContainer.style.display = 'block';
        listContainer.style.display = 'none';
      }
    }
    
    async function loadMapData() {
      if (!map) return;
      
      // Get filter values
      const categoryFilter = document.getElementById('category-filter').value;
      const typeFilter = document.getElementById('type-filter').value;
      
      // Clear existing markers
      markers.forEach(m => m.remove());
      markers = [];
      
      try {
        // Load requests (if not filtering to resources only)
        let requests = [];
        if (typeFilter !== 'resource') {
          let query = db.from('requests').select('*').eq('status', 'active').eq('disaster_id', DISASTER_ID);
          if (categoryFilter !== 'all') query = query.eq('need_type_id', categoryFilter);
          const { data } = await query.limit(100);
          requests = data || [];
        }
        
        // Load resources (if not filtering to requests only)
        let resources = [];
        if (typeFilter !== 'request') {
          let query = db.from('resources').select('*').eq('status', 'active').eq('disaster_id', DISASTER_ID);
          if (categoryFilter !== 'all') query = query.eq('resource_type_id', categoryFilter);
          const { data } = await query.limit(100);
          resources = data || [];
        }
        
        console.log('Map data:', { requests: requests.length, resources: resources.length, filters: { categoryFilter, typeFilter } });
        
        // Add request markers (red)
        (requests || []).forEach(req => {
          // Use metadata lat/lng if available, otherwise generate near Burnsville
          const lat = req.metadata?.lat || (35.92 + (Math.random() - 0.5) * 0.2);
          const lng = req.metadata?.lng || (-82.30 + (Math.random() - 0.5) * 0.2);
          
          const el = document.createElement('div');
          el.className = 'map-marker request';
          el.innerHTML = getCategoryEmoji(req.need_type_id);
          el.style.cssText = `
            width: 36px; height: 36px;
            background: var(--sos-red);
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
          `;
          
          const popup = new mapboxgl.Popup({ offset: 25, maxWidth: '280px' }).setHTML(`
            <div style="padding: 0.5rem;">
              <strong style="color: var(--sos-red);">üÜò ${req.need_type_id || 'Need'}</strong>
              <p style="margin: 0.5rem 0 0.25rem; font-weight: 500;">${req.contact_name || 'Anonymous'}</p>
              <p style="margin: 0; font-size: 0.85rem; color: #666;">${req.title || req.description?.substring(0, 60) || 'Request'}</p>
              <p style="margin: 0.25rem 0; font-size: 0.8rem; color: #888;">üìç ${req.location_description || 'WNC Area'}</p>
              <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem;">
                <span style="padding: 0.125rem 0.5rem; background: ${getUrgencyColor(req.urgency)}; color: white; border-radius: 4px; font-size: 0.7rem;">${req.urgency || 'medium'}</span>
                <button onclick="findMatchesFor('request', '${req.id}')" style="padding: 0.25rem 0.5rem; background: var(--sos-blue); border: none; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Find Matches</button>
              </div>
            </div>
          `);
          
          const marker = new mapboxgl.Marker(el)
            .setLngLat([lng, lat])
            .setPopup(popup)
            .addTo(map);
          
          markers.push(marker);
        });
        
        // Add resource markers (navy)
        (resources || []).forEach(res => {
          const lat = res.metadata?.lat || (35.92 + (Math.random() - 0.5) * 0.2);
          const lng = res.metadata?.lng || (-82.30 + (Math.random() - 0.5) * 0.2);
          
          const el = document.createElement('div');
          el.className = 'map-marker resource';
          el.innerHTML = getCategoryEmoji(res.resource_type_id);
          el.style.cssText = `
            width: 36px; height: 36px;
            background: var(--sos-navy);
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
          `;
          
          const popup = new mapboxgl.Popup({ offset: 25, maxWidth: '280px' }).setHTML(`
            <div style="padding: 0.5rem;">
              <strong style="color: var(--sos-navy);">ü§ù ${res.resource_type_id || 'Resource'}</strong>
              <p style="margin: 0.5rem 0 0.25rem; font-weight: 500;">${res.contact_name || 'Provider'}</p>
              <p style="margin: 0; font-size: 0.85rem; color: #666;">${res.title || res.description?.substring(0, 60) || 'Resource'}</p>
              <p style="margin: 0.25rem 0; font-size: 0.8rem; color: #888;">üìç ${res.location_description || 'WNC Area'}</p>
              <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem;">
                <span style="padding: 0.125rem 0.5rem; background: var(--sos-green); color: white; border-radius: 4px; font-size: 0.7rem;">Available</span>
                <button onclick="findMatchesFor('resource', '${res.id}')" style="padding: 0.25rem 0.5rem; background: var(--sos-blue); border: none; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Find Requests</button>
              </div>
            </div>
          `);
          
          const marker = new mapboxgl.Marker(el)
            .setLngLat([lng, lat])
            .setPopup(popup)
            .addTo(map);
          
          markers.push(marker);
        });
        
      } catch (err) {
        console.error('Error loading map data:', err);
      }
    }
    
    // Clean text - decode URL encoding and clean up titles
    function cleanText(text) {
      if (!text) return '';
      // Decode URL encoding
      let decoded = text.replace(/\+/g, ' ');
      try { decoded = decodeURIComponent(decoded); } catch(e) {}
      // Remove category prefix if present (e.g., "housing: ")
      decoded = decoded.replace(/^(housing|food|medical|transport|supplies|volunteer):\s*/i, '');
      return decoded.trim();
    }
    
    async function loadListView() {
      const categoryFilter = document.getElementById('category-filter').value;
      const typeFilter = document.getElementById('type-filter').value;
      const container = document.getElementById('list-container');
      
      let html = '<div style="display: grid; gap: 1rem; max-width: 800px; margin: 0 auto;">';
      
      try {
        // Load requests
        if (typeFilter !== 'resource') {
          let query = db.from('requests').select('*').eq('status', 'active').eq('disaster_id', DISASTER_ID);
          if (categoryFilter !== 'all') query = query.eq('need_type_id', categoryFilter);
          const { data: requests } = await query.order('created_at', { ascending: false }).limit(50);
          
          (requests || []).forEach(req => {
            const title = cleanText(req.title || req.description?.substring(0, 80) || 'Request for help');
            const location = cleanText(req.location_description || 'Western NC');
            const name = req.contact_name || 'Community Member';
            const category = req.need_type_id?.charAt(0).toUpperCase() + req.need_type_id?.slice(1) || 'Request';
            
            html += `
              <div style="background: white; border-radius: 16px; padding: 1.25rem 1.5rem; box-shadow: 0 2px 12px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 20px rgba(0,0,0,0.12)';" onmouseout="this.style.transform='none';this.style.boxShadow='0 2px 12px rgba(0,0,0,0.08)';">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                  <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; color: white; background: var(--sos-red); padding: 0.2rem 0.6rem; border-radius: 20px; font-weight: 600;">
                        üÜò ${category}
                      </span>
                      <span style="font-size: 0.7rem; color: white; background: ${getUrgencyColor(req.urgency)}; padding: 0.2rem 0.5rem; border-radius: 20px; text-transform: capitalize;">${req.urgency || 'medium'}</span>
                    </div>
                    <h4 style="margin: 0 0 0.25rem; font-size: 1rem; font-weight: 600; color: var(--sos-gray-900);">${name}</h4>
                    <p style="margin: 0 0 0.5rem; font-size: 0.9rem; color: var(--sos-gray-700); line-height: 1.4;">${title}</p>
                    <p style="margin: 0; font-size: 0.8rem; color: var(--sos-gray-500); display: flex; align-items: center; gap: 0.25rem;">
                      <span>üìç</span> ${location}
                    </p>
                  </div>
                  <button onclick="findMatchesFor('request', '${req.id}')" style="padding: 0.6rem 1rem; background: linear-gradient(135deg, var(--sos-blue) 0%, var(--sos-blue-dark) 100%); color: var(--sos-navy); border: none; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Find Matches</button>
                </div>
              </div>
            `;
          });
        }
        
        // Load resources
        if (typeFilter !== 'request') {
          let query = db.from('resources').select('*').eq('status', 'active').eq('disaster_id', DISASTER_ID);
          if (categoryFilter !== 'all') query = query.eq('resource_type_id', categoryFilter);
          const { data: resources } = await query.order('created_at', { ascending: false }).limit(50);
          
          (resources || []).forEach(res => {
            const title = cleanText(res.title || res.description?.substring(0, 80) || 'Resource available');
            const location = cleanText(res.location_description || 'Western NC');
            const name = res.contact_name || 'Community Helper';
            const category = res.resource_type_id?.charAt(0).toUpperCase() + res.resource_type_id?.slice(1) || 'Resource';
            
            html += `
              <div style="background: white; border-radius: 16px; padding: 1.25rem 1.5rem; box-shadow: 0 2px 12px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 20px rgba(0,0,0,0.12)';" onmouseout="this.style.transform='none';this.style.boxShadow='0 2px 12px rgba(0,0,0,0.08)';">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                  <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; color: white; background: var(--sos-navy); padding: 0.2rem 0.6rem; border-radius: 20px; font-weight: 600;">
                        ü§ù ${category}
                      </span>
                      <span style="font-size: 0.7rem; color: white; background: var(--sos-green); padding: 0.2rem 0.5rem; border-radius: 20px;">Available</span>
                    </div>
                    <h4 style="margin: 0 0 0.25rem; font-size: 1rem; font-weight: 600; color: var(--sos-gray-900);">${name}</h4>
                    <p style="margin: 0 0 0.5rem; font-size: 0.9rem; color: var(--sos-gray-700); line-height: 1.4;">${title}</p>
                    <p style="margin: 0; font-size: 0.8rem; color: var(--sos-gray-500); display: flex; align-items: center; gap: 0.25rem;">
                      <span>üìç</span> ${location}
                    </p>
                  </div>
                  <button onclick="findMatchesFor('resource', '${res.id}')" style="padding: 0.6rem 1rem; background: linear-gradient(135deg, var(--sos-blue) 0%, var(--sos-blue-dark) 100%); color: var(--sos-navy); border: none; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Find Requests</button>
                </div>
              </div>
            `;
          });
        }
        
        html += '</div>';
        container.innerHTML = html || '<p style="text-align: center; color: #666;">No results found</p>';
        
      } catch (err) {
        console.error('List view error:', err);
        container.innerHTML = '<p style="color: var(--sos-red);">Error loading data</p>';
      }
    }
    
    function findMatchesFor(type, id) {
      // Navigate to partner dashboard with pre-selected item
      // For now, show alert with match info
      alert(`Finding matches for ${type} ${id}...\n\nIn production, this opens the match engine or partner dashboard.`);
      // Could also: window.location.href = `partner.html?match=${type}&id=${id}`;
    }
    
    function getCategoryEmoji(category) {
      const emojis = {
        housing: 'üè†', food: 'üçΩÔ∏è', medical: 'üè•', transport: 'üöó',
        supplies: 'üì¶', volunteer: 'üôã', default: 'üìç'
      };
      return emojis[category] || emojis.default;
    }
    
    function getUrgencyColor(urgency) {
      const colors = {
        critical: '#EF4E4B', high: '#F97316', medium: '#FFC107', low: '#34A853'
      };
      return colors[urgency] || colors.medium;
    }
    
    // ==================== DASHBOARD ====================
    async function loadDashboardData() {
      try {
        // Get counts
        const [reqResult, resResult, matchResult] = await Promise.all([
          db.from('requests').select('id', { count: 'exact' }).eq('status', 'active'),
          db.from('resources').select('id', { count: 'exact' }).eq('status', 'active'),
          db.from('matches').select('id', { count: 'exact' })
        ]);
        
        document.getElementById('stat-requests').textContent = reqResult.count || 0;
        document.getElementById('stat-resources').textContent = resResult.count || 0;
        document.getElementById('stat-matches').textContent = matchResult.count || 0;
        document.getElementById('stat-helped').textContent = (matchResult.count || 0) * 3; // estimate
        
        // Load recent activity
        const { data: recentIntakes } = await db
          .from('intakes')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(10);
        
        const activityList = document.getElementById('activity-list');
        activityList.innerHTML = '';
        
        if (recentIntakes && recentIntakes.length > 0) {
          recentIntakes.forEach(intake => {
            const isRequest = intake.intake_type === 'request';
            const li = document.createElement('li');
            li.className = 'activity-item';
            li.innerHTML = `
              <div class="activity-icon ${isRequest ? 'request' : 'resource'}">${isRequest ? 'üÜò' : 'ü§ù'}</div>
              <div class="activity-content">
                <h4>${intake.contact_name || 'Anonymous'}</h4>
                <p>${isRequest ? 'Requested help' : 'Offered help'} - ${intake.raw_data?.category || 'general'}</p>
              </div>
              <span class="activity-time">${timeAgo(new Date(intake.created_at))}</span>
            `;
            activityList.appendChild(li);
          });
        } else {
          activityList.innerHTML = '<li class="activity-item"><div class="activity-content"><p>No recent activity</p></div></li>';
        }
        
      } catch (err) {
        console.error('Dashboard error:', err);
      }
    }
    
    function timeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      return Math.floor(seconds / 86400) + 'd ago';
    }
    
    // ==================== TOAST NOTIFICATIONS ====================
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    
    // ==================== LIVE STATS ====================
    async function loadHomeStats() {
      try {
        const [reqResult, resResult, matchResult] = await Promise.all([
          db.from('requests').select('id', { count: 'exact' }).eq('status', 'active'),
          db.from('resources').select('id', { count: 'exact' }).eq('status', 'active'),
          db.from('matches').select('id', { count: 'exact' })
        ]);
        
        document.getElementById('home-requests').textContent = reqResult.count || 0;
        document.getElementById('home-resources').textContent = resResult.count || 0;
        document.getElementById('home-matches').textContent = matchResult.count || 0;
      } catch (err) {
        console.error('Stats error:', err);
      }
    }
    
    // Refresh stats every 30 seconds
    setInterval(loadHomeStats, 30000);
  </script>
</body>
</html>
