<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center</title>
    <style>
        :root {
            --bg: #0a0f0a;
            --bg-secondary: #0d120d;
            --card-bg: #141f14;
            --card-border: #1e2e1e;
            --card-hover: #1a2a1a;
            --text: #ffffff;
            --text-secondary: #8a9a8a;
            --text-dim: #5a6a5a;
            --green: #2d5a2d;
            --green-light: #4a8c4a;
            --green-bright: #5cb85c;
            --green-glow: rgba(92, 184, 92, 0.3);
            --red: #8b3a3a;
            --red-light: #a85454;
            --gold: #d4a530;
            --blue: #4a90d4;
            --purple: #8b5cf6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--card-border);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--green-light) 0%, var(--green) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        /* Main Navigation */
        .main-nav {
            display: flex;
            gap: 4px;
            background: var(--card-bg);
            padding: 4px;
            border-radius: 10px;
        }

        .nav-tab {
            padding: 8px 20px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-tab:hover {
            color: var(--text);
            background: var(--card-hover);
        }

        .nav-tab.active {
            background: var(--green);
            color: var(--text);
        }

        .nav-tab .badge {
            background: var(--red-light);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--card-bg);
            border-radius: 20px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .user-badge .avatar {
            width: 24px;
            height: 24px;
            background: var(--green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* Main container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Page views */
        .page { display: none; }
        .page.active { display: block; }

        /* Metrics bar */
        .metrics-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 16px;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .metric-value.positive { color: var(--green-bright); }
        .metric-value.warning { color: var(--gold); }
        .metric-value.danger { color: var(--red-light); }

        /* Section headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--card-border);
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .section-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--card-border);
            background: var(--card-bg);
            color: var(--text);
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--card-hover);
            border-color: var(--green);
        }

        .btn.primary {
            background: var(--green);
            border-color: var(--green);
        }

        .btn.primary:hover {
            background: var(--green-light);
        }

        /* Filter tabs */
        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-tab:hover {
            color: var(--text);
            border-color: var(--green);
        }

        .filter-tab.active {
            background: var(--green);
            border-color: var(--green);
            color: var(--text);
        }

        /* Project cards */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .project-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-card:hover {
            background: var(--card-hover);
            border-color: var(--green);
            transform: translateY(-2px);
        }

        .project-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .project-icon { font-size: 1.5rem; }
        .project-name { font-weight: 600; font-size: 1rem; }

        .project-stats {
            display: flex;
            gap: 12px;
            font-size: 0.8125rem;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat.p0 { color: var(--red-light); }
        .stat.p1 { color: var(--gold); }
        .stat.done { color: var(--green-bright); }

        /* Task list */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .task-item:hover {
            background: var(--card-hover);
            border-color: var(--green);
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--card-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .task-item:hover .task-checkbox { border-color: var(--green); }
        .task-item.done .task-checkbox { background: var(--green); border-color: var(--green); }
        .task-item.done .task-checkbox::after { content: '‚úì'; color: white; font-size: 12px; }

        .task-priority {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .task-priority.P0 { background: var(--red); color: white; }
        .task-priority.P1 { background: var(--gold); color: #1a1a1a; }
        .task-priority.P2 { background: var(--card-border); color: var(--text-secondary); }

        .task-content { flex: 1; min-width: 0; }
        .task-title { font-weight: 500; margin-bottom: 2px; }

        .task-meta {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .task-project {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .task-project.sos { background: rgba(92, 184, 92, 0.2); color: var(--green-bright); }
        .task-project.reforge { background: rgba(74, 144, 212, 0.2); color: var(--blue); }
        .task-project.harmony { background: rgba(212, 165, 48, 0.2); color: var(--gold); }

        .task-assignee {
            width: 28px;
            height: 28px;
            background: var(--green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        /* Intelligence Feed */
        .feed-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .feed-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .feed-card:hover { border-color: var(--green); }

        .feed-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px 20px;
            cursor: pointer;
        }

        .feed-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            background: var(--card-hover);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feed-content { flex: 1; min-width: 0; }
        .feed-title { font-weight: 600; font-size: 1rem; margin-bottom: 4px; }
        .feed-summary { font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5; }

        .feed-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .feed-tags { display: flex; gap: 6px; flex-wrap: wrap; }

        .feed-tag {
            padding: 3px 8px;
            border-radius: 4px;
            background: var(--card-hover);
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .feed-tag.competitive { color: var(--red-light); }
        .feed-tag.opportunity { color: var(--green-bright); }
        .feed-tag.urgent { color: var(--gold); background: rgba(212, 165, 48, 0.15); }
        .feed-tag.market { color: var(--blue); }
        .feed-tag.technical { color: var(--purple); }
        .feed-tag.palantir { color: var(--red-light); }
        .feed-tag.sos { color: var(--green-bright); }
        .feed-tag.reforge { color: var(--blue); }
        .feed-tag.harmony { color: var(--gold); }

        .feed-author {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .feed-author-avatar {
            width: 20px;
            height: 20px;
            background: var(--green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
        }

        .feed-time { font-size: 0.75rem; color: var(--text-dim); }

        .feed-expand-icon {
            color: var(--text-dim);
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .feed-card.expanded .feed-expand-icon { transform: rotate(180deg); }

        .feed-details {
            display: none;
            padding: 0 20px 20px;
            border-top: 1px solid var(--card-border);
        }

        .feed-card.expanded .feed-details { display: block; }

        .feed-section { margin-top: 16px; }

        .feed-section-title {
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .feed-section ul { margin: 0; padding-left: 20px; }
        .feed-section li { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 4px; }

        .feed-quote {
            border-left: 3px solid var(--green);
            padding-left: 16px;
            margin: 12px 0;
            font-style: italic;
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }

        .feed-insight {
            background: rgba(92, 184, 92, 0.1);
            border: 1px solid rgba(92, 184, 92, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 12px;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .feed-insight-label {
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--green-bright);
            margin-bottom: 4px;
        }

        .feed-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--card-border);
            flex-wrap: wrap;
        }

        /* Costs page */
        .costs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .cost-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
        }

        .cost-card h3 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cost-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .cost-detail {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        /* Pipeline table */
        .pipeline-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .pipeline-table th, .pipeline-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--card-border);
        }

        .pipeline-table th {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .deal-amount { color: var(--green-bright); font-weight: 600; }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 16px; }
            .main-nav { display: none; }
            .projects-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-icon">‚ö°</div>
            <span>COMMAND CENTER</span>
        </div>
        <nav class="main-nav">
            <button class="nav-tab active" data-page="dashboard">üìä Dashboard</button>
            <button class="nav-tab" data-page="intelligence">üì° Intel <span class="badge" id="intel-count">0</span></button>
            <button class="nav-tab" data-page="tasks">‚úÖ Tasks</button>
            <button class="nav-tab" data-page="costs">üí∞ Costs</button>
        </nav>
        <div class="header-right">
            <div class="user-badge">
                <div class="avatar">J</div>
                <span>Jonathan</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- DASHBOARD PAGE -->
        <div class="page active" id="page-dashboard">
            <div class="metrics-bar">
                <div class="metric-card">
                    <div class="metric-label">Reforge Pipeline</div>
                    <div class="metric-value positive">$311K</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Won 2025</div>
                    <div class="metric-value">$50K</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Tasks P0/P1</div>
                    <div class="metric-value warning" id="urgent-tasks-dash">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">API Costs (Today)</div>
                    <div class="metric-value" id="costs-today">-</div>
                </div>
            </div>

            <div class="section-header">
                <div class="section-title">Projects</div>
            </div>
            <div class="projects-grid" id="projects-grid"></div>

            <div class="section-header">
                <div class="section-title">Recent Intel</div>
                <button class="btn" onclick="showPage('intelligence')">View All ‚Üí</button>
            </div>
            <div class="feed-container" id="recent-briefs"></div>
        </div>

        <!-- INTELLIGENCE PAGE -->
        <div class="page" id="page-intelligence">
            <div class="section-header">
                <div class="section-title">üì° Intelligence Feed</div>
                <div class="section-actions">
                    <button class="btn" onclick="toggleAllBriefs()">Expand All</button>
                </div>
            </div>

            <div class="filter-tabs" id="intel-filters">
                <div class="filter-tab active" data-project="all">All Projects</div>
                <div class="filter-tab" data-project="sos">üÜò SOS</div>
                <div class="filter-tab" data-project="reforge">üíº Reforge</div>
                <div class="filter-tab" data-project="harmony">üéØ Harmony</div>
                <div class="filter-tab" data-project="general">üåê General</div>
            </div>
            <div class="filter-tabs" id="intel-type-filters">
                <div class="filter-tab active" data-type="all">All Types</div>
                <div class="filter-tab" data-type="competitive">‚öîÔ∏è Competitive</div>
                <div class="filter-tab" data-type="market">üìä Market</div>
                <div class="filter-tab" data-type="technical">üîß Technical</div>
                <div class="filter-tab" data-type="opportunity">üí° Opportunity</div>
            </div>

            <div class="feed-container" id="feed-container"></div>
        </div>

        <!-- TASKS PAGE -->
        <div class="page" id="page-tasks">
            <div class="section-header">
                <div class="section-title">‚úÖ All Tasks</div>
                <div class="section-actions">
                    <button class="btn primary" onclick="addTask()">+ Add Task</button>
                </div>
            </div>

            <div class="filter-tabs" id="task-project-filters">
                <div class="filter-tab active" data-project="all">All Projects</div>
                <div class="filter-tab" data-project="sos">üÜò SOS</div>
                <div class="filter-tab" data-project="reforge">üíº Reforge</div>
                <div class="filter-tab" data-project="harmony">üéØ Harmony</div>
            </div>
            <div class="filter-tabs" id="task-status-filters">
                <div class="filter-tab active" data-filter="all">All</div>
                <div class="filter-tab" data-filter="pending">Pending</div>
                <div class="filter-tab" data-filter="in_progress">In Progress</div>
                <div class="filter-tab" data-filter="done">Done</div>
            </div>

            <div class="task-list" id="task-list"></div>
        </div>

        <!-- COSTS PAGE -->
        <div class="page" id="page-costs">
            <div class="section-header">
                <div class="section-title">üí∞ API Costs</div>
            </div>

            <div class="costs-grid" id="costs-grid">
                <div class="cost-card">
                    <h3>Loading...</h3>
                    <div class="cost-value">-</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let tasksData = null;
        let briefsData = null;
        let costsData = null;
        let currentPage = 'dashboard';
        let currentTaskFilter = 'all';
        let currentTaskProject = 'all';
        let currentIntelProject = 'all';
        let currentIntelType = 'all';

        // Load data
        async function loadData() {
            try {
                const [tasksRes, briefsRes, costsRes] = await Promise.all([
                    fetch('data/tasks.json'),
                    fetch('data/briefs.json'),
                    fetch('data/costs.json')
                ]);
                tasksData = await tasksRes.json();
                briefsData = await briefsRes.json();
                costsData = await costsRes.json();
            } catch (e) {
                console.error('Failed to load data:', e);
                tasksData = { projects: {} };
                briefsData = { briefs: [] };
                costsData = {};
            }
            render();
        }

        // Navigation
        function showPage(page) {
            currentPage = page;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.add('active');
            document.querySelector(`.nav-tab[data-page="${page}"]`).classList.add('active');
            render();
        }

        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => showPage(tab.dataset.page));
        });

        // Render
        function render() {
            renderProjects();
            renderBriefs();
            renderTasks();
            renderCosts();
            updateMetrics();
        }

        // Time formatting
        function timeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diff = Math.floor((now - then) / 1000);
            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
            return then.toLocaleDateString();
        }

        // Render projects
        function renderProjects() {
            const grid = document.getElementById('projects-grid');
            const projects = tasksData?.projects || {};
            
            const icons = { sos: 'üÜò', reforge: 'üíº', harmony: 'üéØ', grunt: '‚ö°', context_graph: 'üß†' };

            grid.innerHTML = Object.entries(projects).map(([slug, project]) => {
                const tasks = project.tasks || [];
                const p0 = tasks.filter(t => t.status !== 'done' && t.priority === 'P0').length;
                const p1 = tasks.filter(t => t.status !== 'done' && t.priority === 'P1').length;
                const done = tasks.filter(t => t.status === 'done').length;

                return `
                    <div class="project-card" onclick="showProjectTasks('${slug}')">
                        <div class="project-header">
                            <span class="project-icon">${icons[slug] || 'üìÅ'}</span>
                            <span class="project-name">${project.name}</span>
                        </div>
                        <div class="project-stats">
                            ${p0 > 0 ? `<span class="stat p0">üî¥ ${p0} P0</span>` : ''}
                            ${p1 > 0 ? `<span class="stat p1">üü° ${p1}</span>` : ''}
                            ${done > 0 ? `<span class="stat done">‚úì ${done}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showProjectTasks(slug) {
            currentTaskProject = slug;
            showPage('tasks');
            document.querySelectorAll('#task-project-filters .filter-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.project === slug);
            });
            renderTasks();
        }

        // Render briefs (intelligence)
        function renderBriefs() {
            const fullContainer = document.getElementById('feed-container');
            const recentContainer = document.getElementById('recent-briefs');
            let briefs = briefsData?.briefs || [];
            
            // Update intel count badge
            document.getElementById('intel-count').textContent = briefs.length;

            // Filter by project
            if (currentIntelProject !== 'all') {
                briefs = briefs.filter(b => {
                    const tags = b.tags || [];
                    if (currentIntelProject === 'general') {
                        return !tags.includes('sos') && !tags.includes('reforge') && !tags.includes('harmony');
                    }
                    return tags.includes(currentIntelProject);
                });
            }

            // Filter by type
            if (currentIntelType !== 'all') {
                briefs = briefs.filter(b => b.type === currentIntelType || (b.tags || []).includes(currentIntelType));
            }

            // Sort by timestamp
            briefs = [...briefs].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const renderBrief = brief => {
                const details = brief.details || {};
                let detailsHtml = '';

                if (details.source) {
                    let sourceHtml = details.sourceUrl 
                        ? `<a href="${details.sourceUrl}" target="_blank" style="color: var(--blue); text-decoration: none;">${details.source} ‚Üó</a>`
                        : details.source;
                    
                    let additionalHtml = '';
                    if (details.additionalSources?.length) {
                        additionalHtml = '<div style="margin-top: 8px; font-size: 0.8rem;">' +
                            details.additionalSources.map(s => 
                                `<a href="${s.url}" target="_blank" style="color: var(--text-secondary); text-decoration: none; display: block; margin-top: 4px;">${s.name} ‚Üó</a>`
                            ).join('') + '</div>';
                    }
                    
                    detailsHtml += `<div class="feed-section">
                        <div class="feed-section-title">Sources</div>
                        <div style="font-size: 0.875rem;">${sourceHtml}${additionalHtml}</div>
                    </div>`;
                }

                if (details.keyFacts?.length) {
                    detailsHtml += `<div class="feed-section">
                        <div class="feed-section-title">Key Facts</div>
                        <ul>${details.keyFacts.map(f => `<li>${f}</li>`).join('')}</ul>
                    </div>`;
                }

                if (details.quote) {
                    detailsHtml += `<div class="feed-quote">"${details.quote}"</div>`;
                }

                ['theirWeakness', 'whatGothamDoes', 'customSteps', 'keyTrends', 'nextSteps'].forEach(key => {
                    if (details[key]?.length) {
                        const titles = {
                            theirWeakness: 'Their Weakness',
                            whatGothamDoes: 'What Gotham Does',
                            customSteps: 'Custom Steps',
                            keyTrends: 'Key Trends',
                            nextSteps: 'Next Steps'
                        };
                        detailsHtml += `<div class="feed-section">
                            <div class="feed-section-title">${titles[key]}</div>
                            <ul>${details[key].map(x => `<li>${x}</li>`).join('')}</ul>
                        </div>`;
                    }
                });

                const insight = details.sosOpportunity || details.sosDifferentiation || details.approach;
                if (insight) {
                    detailsHtml += `<div class="feed-insight">
                        <div class="feed-insight-label">üí° SOS Insight</div>
                        ${insight}
                    </div>`;
                }

                if (details.actionItems?.length) {
                    detailsHtml += `<div class="feed-actions">
                        ${details.actionItems.map(a => `<button class="btn">${a}</button>`).join('')}
                    </div>`;
                }

                return `
                    <div class="feed-card" data-id="${brief.id}">
                        <div class="feed-header" onclick="toggleBrief('${brief.id}')">
                            <div class="feed-icon">${brief.icon}</div>
                            <div class="feed-content">
                                <div class="feed-title">${brief.title}</div>
                                <div class="feed-summary">${brief.summary}</div>
                                <div class="feed-meta">
                                    <div class="feed-tags">
                                        ${(brief.tags || []).map(t => `<span class="feed-tag ${t}">${t}</span>`).join('')}
                                    </div>
                                    <div class="feed-author">
                                        <div class="feed-author-avatar">${brief.author?.[0] || 'H'}</div>
                                        ${brief.author || 'Henry'}
                                    </div>
                                    <div class="feed-time">${timeAgo(brief.timestamp)}</div>
                                </div>
                            </div>
                            <div class="feed-expand-icon">‚ñº</div>
                        </div>
                        <div class="feed-details">${detailsHtml}</div>
                    </div>
                `;
            };

            fullContainer.innerHTML = briefs.map(renderBrief).join('');
            recentContainer.innerHTML = briefs.slice(0, 3).map(renderBrief).join('');
        }

        function toggleBrief(id) {
            document.querySelectorAll(`.feed-card[data-id="${id}"]`).forEach(card => {
                card.classList.toggle('expanded');
            });
        }

        function toggleAllBriefs() {
            const cards = document.querySelectorAll('#feed-container .feed-card');
            const anyExpanded = [...cards].some(c => c.classList.contains('expanded'));
            cards.forEach(c => c.classList.toggle('expanded', !anyExpanded));
        }

        // Intel filters
        document.getElementById('intel-filters').addEventListener('click', e => {
            if (e.target.classList.contains('filter-tab')) {
                document.querySelectorAll('#intel-filters .filter-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                currentIntelProject = e.target.dataset.project;
                renderBriefs();
            }
        });

        document.getElementById('intel-type-filters').addEventListener('click', e => {
            if (e.target.classList.contains('filter-tab')) {
                document.querySelectorAll('#intel-type-filters .filter-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                currentIntelType = e.target.dataset.type;
                renderBriefs();
            }
        });

        // Render tasks
        function renderTasks() {
            const list = document.getElementById('task-list');
            const projects = tasksData?.projects || {};
            
            let allTasks = [];
            Object.entries(projects).forEach(([slug, project]) => {
                (project.tasks || []).forEach(task => {
                    allTasks.push({ ...task, projectSlug: slug, projectName: project.name });
                });
            });

            // Filter by project
            if (currentTaskProject !== 'all') {
                allTasks = allTasks.filter(t => t.projectSlug === currentTaskProject);
            }

            // Filter by status
            if (currentTaskFilter !== 'all') {
                allTasks = allTasks.filter(t => t.status === currentTaskFilter);
            }

            // Sort
            const priorityOrder = { P0: 0, P1: 1, P2: 2, P3: 3 };
            const statusOrder = { pending: 0, in_progress: 1, blocked: 2, done: 3 };
            allTasks.sort((a, b) => {
                const pDiff = (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2);
                if (pDiff !== 0) return pDiff;
                return (statusOrder[a.status] || 0) - (statusOrder[b.status] || 0);
            });

            list.innerHTML = allTasks.map(task => `
                <div class="task-item ${task.status || ''}" data-id="${task.id}">
                    <div class="task-checkbox" onclick="toggleTask('${task.id}', event)"></div>
                    <span class="task-priority ${task.priority || 'P2'}">${task.priority || 'P2'}</span>
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            <span class="task-project ${task.projectSlug}">${task.projectSlug.toUpperCase()}</span>
                            ${task.notes ? `<span>${task.notes}</span>` : ''}
                        </div>
                    </div>
                    <div class="task-assignee">H</div>
                </div>
            `).join('') || '<div style="color: var(--text-secondary); padding: 20px;">No tasks found</div>';

            // Update urgent count
            const urgentCount = Object.values(tasksData?.projects || {}).reduce((sum, p) => {
                return sum + (p.tasks || []).filter(t => t.status !== 'done' && (t.priority === 'P0' || t.priority === 'P1')).length;
            }, 0);
            document.getElementById('urgent-tasks-dash').textContent = urgentCount;
        }

        // Task filters
        document.getElementById('task-project-filters').addEventListener('click', e => {
            if (e.target.classList.contains('filter-tab')) {
                document.querySelectorAll('#task-project-filters .filter-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                currentTaskProject = e.target.dataset.project;
                renderTasks();
            }
        });

        document.getElementById('task-status-filters').addEventListener('click', e => {
            if (e.target.classList.contains('filter-tab')) {
                document.querySelectorAll('#task-status-filters .filter-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                currentTaskFilter = e.target.dataset.filter;
                renderTasks();
            }
        });

        function toggleTask(id, event) {
            event.stopPropagation();
            const item = event.target.closest('.task-item');
            item.classList.toggle('done');
        }

        function addTask() {
            const title = prompt('Task title:');
            if (title) alert('Task creation will be connected to Supabase');
        }

        // Render costs
        function renderCosts() {
            const grid = document.getElementById('costs-grid');
            const costs = costsData || {};
            
            let html = '';
            
            if (costs.today !== undefined) {
                document.getElementById('costs-today').textContent = `$${costs.today.toFixed(2)}`;
                html += `
                    <div class="cost-card">
                        <h3>Today</h3>
                        <div class="cost-value ${costs.today > 5 ? 'warning' : ''}">$${costs.today.toFixed(2)}</div>
                    </div>
                `;
            }

            if (costs.yesterday !== undefined) {
                html += `
                    <div class="cost-card">
                        <h3>Yesterday</h3>
                        <div class="cost-value">$${costs.yesterday.toFixed(2)}</div>
                    </div>
                `;
            }

            if (costs.thisMonth !== undefined) {
                html += `
                    <div class="cost-card">
                        <h3>This Month</h3>
                        <div class="cost-value ${costs.thisMonth > 50 ? 'danger' : ''}">$${costs.thisMonth.toFixed(2)}</div>
                        ${costs.lastMonth !== undefined ? `<div class="cost-detail">Last month: $${costs.lastMonth.toFixed(2)}</div>` : ''}
                    </div>
                `;
            }

            if (costs.byModel) {
                html += `
                    <div class="cost-card">
                        <h3>By Model (This Month)</h3>
                        ${Object.entries(costs.byModel).map(([model, val]) => 
                            `<div class="cost-detail">${model}: $${val.toFixed(2)}</div>`
                        ).join('')}
                    </div>
                `;
            }

            grid.innerHTML = html || '<div class="cost-card"><h3>No Data</h3><div class="cost-value">-</div></div>';
        }

        function updateMetrics() {
            // Additional metric updates can go here
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
